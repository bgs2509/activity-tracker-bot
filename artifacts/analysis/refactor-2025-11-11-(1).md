# üéØ –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê: –í–ê–†–ò–ê–ù–¢ B - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-11
**–ê–≤—Ç–æ—Ä:** Claude Code
**–°—Ç–∞—Ç—É—Å:** Ready for Implementation
**–í–µ—Ä—Å–∏—è:** 1.0
**Estimated Effort:** 23-30 —á–∞—Å–æ–≤ (3-4 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è)

---

## üìã EXECUTIVE SUMMARY

### –¶–µ–ª—å
–û–±—ä–µ–¥–∏–Ω–∏—Ç—å UI –¥–≤—É—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Ä—É—á–Ω–æ–π + –∞–≤—Ç–æ–æ–ø—Ä–æ—Å) —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∞.

### –í–∞—Ä–∏–∞–Ω—Ç B: –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ **–†—É—á–Ω–æ–π –ø–æ—Ç–æ–∫:** –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "‚ö°Ô∏è –ê–≤—Ç–æ" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞
- ‚úÖ **–ê–≤—Ç–æ–æ–ø—Ä–æ—Å:** –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚úÖ **–ï–¥–∏–Ω—ã–π StateGroup:** `ActivityStates` –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö
- ‚úÖ **Shared handlers:** –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è
- ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ UX:** –∞–≤—Ç–æ–æ–ø—Ä–æ—Å –æ—Å—Ç–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º (2 —à–∞–≥–∞)

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- üéØ –ì–∏–±–∫–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ü–∏—è "–ê–≤—Ç–æ" –≤ —Ä—É—á–Ω–æ–º –ø–æ—Ç–æ–∫–µ)
- üìâ –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ ~300 —Å—Ç—Ä–æ–∫ (-45% –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
- üßπ –£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–æ–¥–∏–Ω StateGroup)
- üîß –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å

### –†–∏—Å–∫–∏
- ‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚ö†Ô∏è –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º–æ–∂–µ—Ç –∑–∞–ø—É—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ö†Ô∏è FSM state conflicts –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

---

## üìÅ –§–ê–ô–õ–´ –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### üóëÔ∏è –£–¥–∞–ª–∏—Ç—å (1 —Ñ–∞–π–ª)
```
src/api/states/poll.py
```

### ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å (5 —Ñ–∞–π–ª–æ–≤)
```
src/api/states/activity.py                          (minimal changes)
src/api/handlers/activity/activity_creation.py      (major refactoring)
src/api/handlers/poll/poll_response.py              (major refactoring)
src/api/handlers/poll/poll_sender.py                (entry point modification)
src/api/keyboards/time_select.py                    (add auto button)
```

### ‚ûï –°–æ–∑–¥–∞—Ç—å (3 —Ñ–∞–π–ª–∞)
```
src/api/handlers/activity/shared.py                 (NEW - shared logic)
tests/integration/test_activity_flows.py            (NEW - e2e tests)
artifacts/analysis/refactor-2025-11-11-(1).md       (THIS FILE)
```

### üß™ –¢–µ—Å—Ç—ã (2 —Ñ–∞–π–ª–∞)
```
tests/unit/handlers/test_activity_creation.py       (update)
tests/unit/handlers/test_shared.py                  (NEW)
```

---

## üóÇÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ü–õ–ê–ù–ê

| –§–∞–∑–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –í—Ä–µ–º—è | –†–∏—Å–∫ |
|------|----------|-------|------|
| **1** | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ | 2-3—á | –ù–∏–∑–∫–∏–π |
| **2** | –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è FSM States | 2—á | –ù–∏–∑–∫–∏–π |
| **3** | –°–æ–∑–¥–∞–Ω–∏–µ shared –º–æ–¥—É–ª—è | 3-4—á | –ù–∏–∑–∫–∏–π |
| **4** | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä—É—á–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ | 3-4—á | –°—Ä–µ–¥–Ω–∏–π |
| **5** | –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≤—Ç–æ–æ–ø—Ä–æ—Å–∞ | 3-4—á | –°—Ä–µ–¥–Ω–∏–π |
| **6** | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ handlers | 4-5—á | –°—Ä–µ–¥–Ω–∏–π |
| **7** | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | 4-5—á | - |
| **8** | –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –¥–µ–ø–ª–æ–π | 2-3—á | –ù–∏–∑–∫–∏–π |
| **–ò–¢–û–ì–û** | **8 —Ñ–∞–∑** | **23-30—á** | **–ù–∏–∑–∫–∏–π-–°—Ä–µ–¥–Ω–∏–π** |

---

# üéØ –§–ê–ó–ê 1: –ü–û–î–ì–û–¢–û–í–ö–ê –ò –ê–ù–ê–õ–ò–ó

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–†–∏—Å–∫:** üü¢ –ù–ò–ó–ö–ò–ô

## –¶–µ–ª—å
–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Å—Ç–∏ code audit, —Å–æ–∑–¥–∞—Ç—å baseline –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

---

## ‚úÖ TODO 1.1: –°–æ–∑–¥–∞—Ç—å feature branch

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –Ω–∞ master –∏ –≤—Å–µ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ
git status
git checkout master
git pull origin master

# 2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é feature branch
git checkout -b feature/merge-activity-flows-variant-b

# 3. –ó–∞–ø—É—à–∏—Ç—å –≤ remote
git push -u origin feature/merge-activity-flows-variant-b
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Branch —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] Branch –∑–∞–ø—É—à–µ–Ω –≤ remote
- [ ] Working directory clean

**–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
git branch --list feature/merge-activity-flows-variant-b
git ls-remote --heads origin feature/merge-activity-flows-variant-b
```

---

## ‚úÖ TODO 1.2: Backup —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –°–æ–∑–¥–∞—Ç—å backup –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
mkdir -p backups/pre-refactor-2025-11-11

# Backup –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
cp src/api/handlers/activity/activity_creation.py backups/pre-refactor-2025-11-11/
cp src/api/handlers/poll/poll_response.py backups/pre-refactor-2025-11-11/
cp src/api/handlers/poll/poll_sender.py backups/pre-refactor-2025-11-11/
cp src/api/states/poll.py backups/pre-refactor-2025-11-11/
cp src/api/states/activity.py backups/pre-refactor-2025-11-11/
cp src/api/keyboards/time_select.py backups/pre-refactor-2025-11-11/

# –°–æ–∑–¥–∞—Ç—å snapshot –≤—Å–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ handlers
tar -czf backups/pre-refactor-2025-11-11/handlers-snapshot.tar.gz src/api/handlers/

# –°–æ–∑–¥–∞—Ç—å git tag –¥–ª—è —Ç–æ—á–∫–∏ –æ—Ç–∫–∞—Ç–∞
git tag -a pre-refactor-variant-b -m "Snapshot before Variant B refactoring"
git push origin pre-refactor-variant-b
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Backup –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Snapshot –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω
- [ ] Git tag —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—à–µ–Ω

---

## ‚úÖ TODO 1.3: –ü—Ä–æ–≤–µ—Å—Ç–∏ code audit

**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `PollStates` –∏ poll-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞.

### 1.3.1: –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è PollStates

```bash
# –ü–æ–∏—Å–∫ –∏–º–ø–æ—Ä—Ç–æ–≤ PollStates
grep -rn "from.*poll import PollStates" src/ > audit/pollstates_imports.txt

# –ü–æ–∏—Å–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π PollStates
grep -rn "PollStates\." src/ > audit/pollstates_usage.txt

# –ü–æ–¥—Å—á–µ—Ç –≤—Ö–æ–∂–¥–µ–Ω–∏–π
wc -l audit/pollstates_*.txt
```

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `audit/pollstates_analysis.md`
```markdown
# PollStates Usage Analysis

## Imports
- poll_response.py: line 15
- poll_sender.py: line 12

## Usage Locations
- poll_response.py:
  - Line 87: @router.callback_query(PollStates.waiting_for_poll_category, ...)
  - Line 195: @router.callback_query(PollStates.waiting_for_poll_description, ...)
  - Line 310: @router.message(PollStates.waiting_for_poll_description)
- poll_sender.py:
  - Line 145: await storage.set_state(key, PollStates.waiting_for_poll_category)

## Mapping to ActivityStates
| PollStates | ActivityStates | Notes |
|------------|---------------|-------|
| waiting_for_poll_category | waiting_for_category | Direct mapping |
| waiting_for_poll_description | waiting_for_description | Direct mapping |
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
- [ ] –í—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –°–æ–∑–¥–∞–Ω mapping PollStates ‚Üí ActivityStates

### 1.3.2: –ù–∞–π—Ç–∏ –≤—Å–µ poll-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ callbacks

```bash
# –ü–æ–∏—Å–∫ poll callbacks
grep -rn "poll_category" src/ > audit/poll_callbacks.txt
grep -rn "poll_cancel" src/ > audit/poll_cancel.txt
grep -rn "poll_" src/ | grep "callback" > audit/poll_callbacks_all.txt
```

**–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:**
- `poll_category_{id}` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
- `poll_cancel` - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–æ—Å–∞
- `activity_desc_{id}` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –æ–±–æ–∏—Ö –ø–æ—Ç–æ–∫–∞—Ö (–ø–æ–¥—Å–∫–∞–∑–∫–∏)
- `activity_cancel_category` - —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ callbacks –Ω–∞–π–¥–µ–Ω—ã
- [ ] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –∫–∞–∫–∏–µ shared, –∫–∞–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ
- [ ] –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ

### 1.3.3: –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞

**–°—Ä–∞–≤–Ω–∏—Ç—å:**
1. `activity_creation.py:process_category_callback()` vs `poll_response.py:handle_poll_category_select()`
2. `activity_creation.py:process_description()` vs `poll_response.py:handle_poll_description()`
3. `activity_creation.py:select_recent_activity()` vs `poll_response.py:handle_poll_recent_activity_select()`

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `audit/code_duplication_analysis.md`
```markdown
# Code Duplication Analysis

## Handler 1: Category Selection
**Files:** activity_creation.py:435-521 vs poll_response.py:375-493
**Duplication:** ~90%
**Differences:**
- Manual: reads period from state
- Poll: calculates period dynamically
- Poll: stores settings and timezone

**Shared logic:**
- Category ID parsing
- State data validation
- Fetching recent activities
- Building description prompt
- FSM timeout scheduling

## Handler 2: Description Input
**Files:** activity_creation.py:409-433 vs poll_response.py:626-726
**Duplication:** ~85%
**Differences:**
- Poll: schedules next poll after saving

**Shared logic:**
- Description validation (min 3 chars)
- Tag extraction
- Activity creation API call
- Success message formatting
- FSM state clearing

## Total Duplication
- Estimated: 65-70%
- Lines: ~300 lines duplicated
- Functions for extraction: 3-4 major functions
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–æ
- [ ] –†–∞–∑–ª–∏—á–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è extraction

---

## ‚úÖ TODO 1.4: –ó–∞–ø—É—Å—Ç–∏—Ç—å baseline —Ç–µ—Å—Ç—ã

**–¶–µ–ª—å:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è baseline
mkdir -p baselines/tests

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ unit tests
pytest tests/unit/handlers/test_activity_creation.py -v > baselines/tests/activity_creation_baseline.log 2>&1
pytest tests/unit/handlers/test_poll_response.py -v > baselines/tests/poll_response_baseline.log 2>&1

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ unit tests —Å coverage
pytest tests/unit/ -v --cov=src/api/handlers --cov-report=html --cov-report=term > baselines/tests/full_baseline.log 2>&1

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å coverage report
cp -r htmlcov baselines/coverage_baseline

# –ó–∞–ø—É—Å—Ç–∏—Ç—å type checking
mypy src/api/handlers/ > baselines/tests/mypy_baseline.log 2>&1

# –ó–∞–ø—É—Å—Ç–∏—Ç—å linting
ruff check src/api/handlers/ > baselines/tests/ruff_baseline.log 2>&1
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã
- [ ] Baseline logs —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- [ ] Coverage baseline —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- [ ] Type checking baseline —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- [ ] Linting baseline —Å–æ—Ö—Ä–∞–Ω–µ–Ω

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**
```markdown
# Baseline Test Results (Pre-Refactor)

## Test Status
- test_activity_creation.py: X passed, Y failed
- test_poll_response.py: X passed, Y failed
- Total: X passed, Y failed

## Coverage
- Overall: XX%
- activity_creation.py: XX%
- poll_response.py: XX%

## Type Checking
- Errors: X
- Warnings: Y

## Linting
- Errors: X
- Warnings: Y
```

---

## ‚úÖ TODO 1.5: –°–æ–∑–¥–∞—Ç—å tracking –¥–æ–∫—É–º–µ–Ω—Ç

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `artifacts/analysis/refactor-progress.md`

```markdown
# Refactor Progress Tracking

**Started:** 2025-11-11
**Expected Completion:** 2025-11-14
**Status:** In Progress

## Phases Completion

- [ ] Phase 1: Preparation (0%)
- [ ] Phase 2: FSM States (0%)
- [ ] Phase 3: Shared Module (0%)
- [ ] Phase 4: Manual Flow (0%)
- [ ] Phase 5: Automatic Poll (0%)
- [ ] Phase 6: Handler Merge (0%)
- [ ] Phase 7: Testing (0%)
- [ ] Phase 8: Documentation (0%)

## Metrics

### Before Refactor
- LOC (handlers): ~730
- Duplication: 65-70%
- StateGroups: 2
- Test Coverage: XX%

### After Refactor (Target)
- LOC (handlers): ~400
- Duplication: <10%
- StateGroups: 1
- Test Coverage: >=85%

## Issues Encountered
_(Log as they occur)_

## Decisions Made
_(Log architectural decisions)_
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Tracking —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [ ] Baseline metrics –∑–∞–ø–∏—Å–∞–Ω—ã

---

## ‚úÖ TODO 1.6: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–î–µ–π—Å—Ç–≤–∏—è:**

```bash
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
pip install -r requirements.txt
pip install -r requirements-dev.txt

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞–∫–µ—Ç–æ–≤
python --version
pytest --version
mypy --version
ruff --version

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pre-commit hooks (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
pre-commit install

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ pre-commit —Ä–∞–±–æ—Ç–∞–µ—Ç
pre-commit run --all-files
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- [ ] Pre-commit hooks –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

# üéØ –§–ê–ó–ê 2: –ö–û–ù–°–û–õ–ò–î–ê–¶–ò–Ø FSM STATES

**–í—Ä–µ–º—è:** 2 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–†–∏—Å–∫:** üü¢ –ù–ò–ó–ö–ò–ô

## –¶–µ–ª—å
–£–¥–∞–ª–∏—Ç—å `PollStates`, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `ActivityStates` –¥–ª—è –æ–±–æ–∏—Ö –ø–æ—Ç–æ–∫–æ–≤.

---

## ‚úÖ TODO 2.1: –û–±–Ω–æ–≤–∏—Ç—å ActivityStates docstring

**–§–∞–π–ª:** `src/api/states/activity.py`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
class ActivityStates(StatesGroup):
    """States for activity recording."""
    waiting_for_period = State()
    waiting_for_category = State()
    waiting_for_description = State()
```

**–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞:**
```python
class ActivityStates(StatesGroup):
    """States for activity recording (both manual and automatic flows).

    This StateGroup is used by both manual activity recording and automatic
    poll response flows. Different flows enter at different states:

    Manual Flow:
        1. waiting_for_period (entry point)
        2. waiting_for_category
        3. waiting_for_description

    Automatic Poll Flow:
        1. waiting_for_category (entry point - period calculated automatically)
        2. waiting_for_description

    The flows converge at waiting_for_category and share handlers from that
    point forward. Flow differentiation is handled via trigger_source in FSM
    state data ("manual" or "automatic").
    """
    waiting_for_period = State()        # Manual: period selection, Auto: skipped
    waiting_for_category = State()      # BOTH flows converge here
    waiting_for_description = State()   # BOTH flows share this
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Docstring –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫ states
- [ ] –û–ø–∏—Å–∞–Ω–∏–µ –æ–±–æ–∏—Ö flows –¥–æ–±–∞–≤–ª–µ–Ω–æ

**–ö–æ–º–º–∏—Ç:**
```bash
git add src/api/states/activity.py
git commit -m "docs(states): update ActivityStates docstring for shared usage"
```

---

## ‚úÖ TODO 2.2: –°–æ–∑–¥–∞—Ç—å mapping —Ñ–∞–π–ª –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `migration/pollstates_to_activitystates_mapping.json`

```json
{
  "state_mapping": {
    "PollStates.waiting_for_poll_category": "ActivityStates.waiting_for_category",
    "PollStates.waiting_for_poll_description": "ActivityStates.waiting_for_description"
  },
  "import_mapping": {
    "from src.api.states.poll import PollStates": "from src.api.states.activity import ActivityStates",
    "from ..states.poll import PollStates": "from ..states.activity import ActivityStates"
  },
  "files_to_update": [
    "src/api/handlers/poll/poll_response.py",
    "src/api/handlers/poll/poll_sender.py"
  ]
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Mapping —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ mappings –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## ‚úÖ TODO 2.3: –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ poll_response.py

**–§–∞–π–ª:** `src/api/handlers/poll/poll_response.py`

**–ù–∞–π—Ç–∏ –∏ –∑–∞–º–µ–Ω–∏—Ç—å:**
```python
# OLD (—É–¥–∞–ª–∏—Ç—å)
from src.api.states.poll import PollStates

# NEW (–¥–æ–±–∞–≤–∏—Ç—å)
from src.api.states.activity import ActivityStates
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –°—Ç–∞—Ä—ã–π –∏–º–ø–æ—Ä—Ç —É–¥–∞–ª–µ–Ω
- [ ] –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤

**–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
grep -n "from.*states" src/api/handlers/poll/poll_response.py
```

---

## ‚úÖ TODO 2.4: –û–±–Ω–æ–≤–∏—Ç—å state references –≤ poll_response.py

**–§–∞–π–ª:** `src/api/handlers/poll/poll_response.py`

**–ù–∞–π—Ç–∏ –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è PollStates –∏ –∑–∞–º–µ–Ω–∏—Ç—å:**

**–ó–∞–º–µ–Ω–∞ 1: Handler –∫–∞—Ç–µ–≥–æ—Ä–∏–∏**
```python
# OLD
@router.callback_query(PollStates.waiting_for_poll_category, F.data.startswith("poll_category_"))

# NEW
@router.callback_query(ActivityStates.waiting_for_category, F.data.startswith("poll_category_"))
```

**–ó–∞–º–µ–Ω–∞ 2: Handler –æ–ø–∏—Å–∞–Ω–∏—è (callback)**
```python
# OLD
@router.callback_query(PollStates.waiting_for_poll_description, F.data.startswith("activity_desc_"))

# NEW
@router.callback_query(ActivityStates.waiting_for_description, F.data.startswith("activity_desc_"))
```

**–ó–∞–º–µ–Ω–∞ 3: Handler –æ–ø–∏—Å–∞–Ω–∏—è (message)**
```python
# OLD
@router.message(PollStates.waiting_for_poll_description)

# NEW
@router.message(ActivityStates.waiting_for_description)
```

**–ó–∞–º–µ–Ω–∞ 4: Handler –æ—Ç–º–µ–Ω—ã**
```python
# OLD
@router.callback_query(PollStates.waiting_for_poll_category, F.data == "poll_cancel")

# NEW
@router.callback_query(ActivityStates.waiting_for_category, F.data == "poll_cancel")
```

**–ó–∞–º–µ–Ω–∞ 5: Set state –≤—ã–∑–æ–≤—ã**
```python
# OLD
await state.set_state(PollStates.waiting_for_poll_description)

# NEW
await state.set_state(ActivityStates.waiting_for_description)
```

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö –≤—Ö–æ–∂–¥–µ–Ω–∏–π:**
```bash
grep -n "PollStates" src/api/handlers/poll/poll_response.py
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ `PollStates.waiting_for_poll_category` ‚Üí `ActivityStates.waiting_for_category`
- [ ] –í—Å–µ `PollStates.waiting_for_poll_description` ‚Üí `ActivityStates.waiting_for_description`
- [ ] –ù–µ—Ç –æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö `PollStates` references

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
```bash
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
grep "PollStates" src/api/handlers/poll/poll_response.py
echo $?  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
```

---

## ‚úÖ TODO 2.5: –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ poll_sender.py

**–§–∞–π–ª:** `src/api/handlers/poll/poll_sender.py`

**–ù–∞–π—Ç–∏ –∏ –∑–∞–º–µ–Ω–∏—Ç—å:**
```python
# OLD
from src.api.states.poll import PollStates

# NEW
from src.api.states.activity import ActivityStates
```

**–û–±–Ω–æ–≤–∏—Ç—å set_state –≤—ã–∑–æ–≤:**
```python
# OLD
await storage.set_state(key, PollStates.waiting_for_poll_category)

# NEW
await storage.set_state(key, ActivityStates.waiting_for_category)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ò–º–ø–æ—Ä—Ç –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] set_state –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ù–µ—Ç –æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö PollStates

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
```bash
grep "PollStates" src/api/handlers/poll/poll_sender.py
echo $?  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 1 (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)
```

---

## ‚úÖ TODO 2.6: –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª poll.py

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ–∞–π–ª –±–æ–ª—å—à–µ –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
grep -r "from.*poll import" src/ --exclude-dir=__pycache__

# –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π - –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª—è—Ç—å
git rm src/api/states/poll.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
git status
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§–∞–π–ª —É–¥–∞–ª–µ–Ω –∏–∑ git
- [ ] –ù–µ—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ poll.py –≤ –ø—Ä–æ–µ–∫—Ç–µ
- [ ] Git status –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ

---

## ‚úÖ TODO 2.7: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é

**–î–µ–π—Å—Ç–≤–∏—è:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python
python -m py_compile src/api/handlers/poll/poll_response.py
python -m py_compile src/api/handlers/poll/poll_sender.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
python -c "from src.api.handlers.poll.poll_response import router"
python -c "from src.api.handlers.poll.poll_sender import send_automatic_poll"

# –ó–∞–ø—É—Å—Ç–∏—Ç—å mypy
mypy src/api/handlers/poll/ --no-error-summary
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ù–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- [ ] –ò–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Type checking –ø—Ä–æ—Ö–æ–¥–∏—Ç

---

## ‚úÖ TODO 2.8: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –§–∞–∑—ã 2

```bash
git add src/api/handlers/poll/poll_response.py
git add src/api/handlers/poll/poll_sender.py
git add migration/pollstates_to_activitystates_mapping.json

git commit -m "refactor(states): consolidate PollStates into ActivityStates

- Remove PollStates, use ActivityStates for all flows
- Update imports in poll_response.py and poll_sender.py
- Replace all PollStates references with ActivityStates
- Delete src/api/states/poll.py
- Add migration mapping documentation

BREAKING CHANGE: PollStates removed, all code must use ActivityStates"
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω
- [ ] Commit message –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- [ ] BREAKING CHANGE –æ—Ç–º–µ—á–µ–Ω

---

# üéØ –§–ê–ó–ê 3: –°–û–ó–î–ê–ù–ò–ï SHARED –ú–û–î–£–õ–Ø

**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–†–∏—Å–∫:** üü¢ –ù–ò–ó–ö–ò–ô

## –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `shared.py` —Å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –¥–ª—è –æ–±–æ–∏—Ö –ø–æ—Ç–æ–∫–æ–≤.

---

## ‚úÖ TODO 3.1: –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª shared.py —Å –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `src/api/handlers/activity/shared.py`

**–ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
"""Shared logic for activity recording flows.

This module contains common functionality used by both manual activity
recording and automatic poll response flows to eliminate code duplication.

Functions:
    validate_description: Validate activity description input
    fetch_and_build_description_prompt: Build description prompt with suggestions
    handle_recent_activity_selection: Process selection of recent activity
    create_and_save_activity: Create and save activity with error handling

Usage:
    from src.api.handlers.activity.shared import (
        validate_description,
        fetch_and_build_description_prompt,
        create_and_save_activity
    )
"""

import logging
from datetime import datetime
from typing import Callable, Awaitable

from aiogram import types
from aiogram.types import InlineKeyboardMarkup
from aiogram.fsm.context import FSMContext

from src.api.dependencies import ServiceContainer
from src.api.keyboards.activity import get_recent_activities_keyboard
from src.api.keyboards.main_menu import get_main_menu_keyboard
from src.application.utils.formatters import (
    format_time,
    format_duration,
    extract_tags
)
from src.application.services import fsm_timeout_service as fsm_timeout_module

logger = logging.getLogger(__name__)


# Functions will be implemented in next TODOs
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§–∞–π–ª —Å–æ–∑–¥–∞–Ω
- [ ] Docstring –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –ò–º–ø–æ—Ä—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] Logger –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
```bash
python -m py_compile src/api/handlers/activity/shared.py
```

---

## ‚úÖ TODO 3.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å validate_description()

**–î–æ–±–∞–≤–∏—Ç—å –≤ shared.py:**

```python
def validate_description(description: str, min_length: int = 3) -> tuple[bool, str | None]:
    """Validate activity description input.

    Checks that description meets minimum length requirements after
    stripping whitespace.

    Args:
        description: Description text to validate
        min_length: Minimum required length in characters (default: 3)

    Returns:
        Tuple of (is_valid, error_message)
        - If valid: (True, None)
        - If invalid: (False, error_message_string)

    Examples:
        >>> is_valid, error_msg = validate_description("ab")
        >>> if not is_valid:
        ...     await message.answer(error_msg)
        ...     return

        >>> is_valid, _ = validate_description("–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º")
        >>> assert is_valid is True

    Note:
        The error message is in Russian (user-facing).
    """
    description = description.strip()

    if not description or len(description) < min_length:
        return False, f"‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º {min_length} —Å–∏–º–≤–æ–ª–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑."

    return True, None
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] Docstring –ø–æ–ª–Ω—ã–π (—Å –ø—Ä–∏–º–µ—Ä–∞–º–∏)
- [ ] –õ–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
- [ ] Type hints –¥–æ–±–∞–≤–ª–µ–Ω—ã

**–ù–∞–ø–∏—Å–∞—Ç—å unit test:**

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `tests/unit/handlers/test_shared.py`

```python
"""Unit tests for shared activity recording logic."""

import pytest
from src.api.handlers.activity.shared import validate_description


class TestValidateDescription:
    """Tests for validate_description function."""

    def test_valid_description(self):
        """Test validation with valid description."""
        is_valid, error = validate_description("–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º")
        assert is_valid is True
        assert error is None

    def test_description_too_short(self):
        """Test validation with too short description."""
        is_valid, error = validate_description("ab")
        assert is_valid is False
        assert "–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞" in error

    def test_empty_description(self):
        """Test validation with empty description."""
        is_valid, error = validate_description("")
        assert is_valid is False
        assert error is not None

    def test_whitespace_only_description(self):
        """Test validation with whitespace only."""
        is_valid, error = validate_description("   ")
        assert is_valid is False
        assert error is not None

    def test_description_with_unicode(self):
        """Test validation with unicode characters."""
        is_valid, error = validate_description("–†–∞–±–æ—Ç–∞ üíº —Å –∫–æ–¥–æ–º")
        assert is_valid is True
        assert error is None

    def test_description_exactly_min_length(self):
        """Test validation with exactly minimum length."""
        is_valid, error = validate_description("abc")
        assert is_valid is True
        assert error is None

    def test_custom_min_length(self):
        """Test validation with custom minimum length."""
        is_valid, error = validate_description("test", min_length=5)
        assert is_valid is False
        assert "–º–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–∞" in error

    def test_description_with_leading_trailing_spaces(self):
        """Test that leading/trailing spaces are stripped."""
        is_valid, error = validate_description("  abc  ")
        assert is_valid is True
        assert error is None
```

**–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç:**
```bash
pytest tests/unit/handlers/test_shared.py::TestValidateDescription -v
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Coverage 100% –¥–ª—è validate_description

---

## ‚úÖ TODO 3.3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å fetch_and_build_description_prompt()

**–î–æ–±–∞–≤–∏—Ç—å –≤ shared.py:**

```python
async def fetch_and_build_description_prompt(
    services: ServiceContainer,
    user_id: int,
    category_id: int,
    start_time: datetime,
    end_time: datetime,
    limit: int = 20
) -> tuple[str, InlineKeyboardMarkup | None]:
    """Fetch recent activities and build description prompt with keyboard.

    Fetches recent activities for the given category and builds a prompt
    message with inline keyboard showing recent activity suggestions.

    Args:
        services: Service container with data access
        user_id: Internal user ID (not Telegram ID)
        category_id: Category ID to filter activities
        start_time: Activity start time (for display)
        end_time: Activity end time (for display)
        limit: Maximum number of recent activities to fetch (default: 20)

    Returns:
        Tuple of (prompt_text, keyboard)
        - prompt_text: Formatted message with time range and instructions
        - keyboard: InlineKeyboardMarkup with recent activity buttons,
                   or None if no recent activities found

    Examples:
        >>> text, keyboard = await fetch_and_build_description_prompt(
        ...     services, 123, 456, start_time, end_time
        ... )
        >>> await message.answer(text, reply_markup=keyboard)

        # With recent activities:
        # text: "‚úèÔ∏è –û–ø–∏—à–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n\n‚è∞ 10:00 ‚Äî 12:00 (2—á)\n\n–í—ã–±–µ—Ä–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö..."
        # keyboard: InlineKeyboardMarkup with suggestion buttons

        # Without recent activities:
        # text: "‚úèÔ∏è –û–ø–∏—à–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n\n‚è∞ 10:00 ‚Äî 12:00 (2—á)\n\n–ù–∞–ø–∏—à–∏, —á–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è..."
        # keyboard: None

    Note:
        All text is in Russian (user-facing).
        Errors are logged but gracefully handled (returns empty activities list).
    """
    # Fetch recent activities
    try:
        response = await services.activity.get_user_activities_by_category(
            user_id=user_id,
            category_id=category_id,
            limit=limit
        )
        recent_activities = (
            response.get("activities", [])
            if isinstance(response, dict)
            else response
        )
    except Exception as e:
        logger.error(
            "Error fetching recent activities for description prompt",
            extra={
                "user_id": user_id,
                "category_id": category_id,
                "error": str(e)
            },
            exc_info=True
        )
        recent_activities = []

    # Format time and duration
    start_time_str = format_time(start_time)
    end_time_str = format_time(end_time)
    duration_minutes = int((end_time - start_time).total_seconds() / 60)
    duration_str = format_duration(duration_minutes)

    # Build prompt text
    text = (
        f"‚úèÔ∏è –û–ø–∏—à–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n\n"
        f"‚è∞ {start_time_str} ‚Äî {end_time_str} ({duration_str})\n\n"
    )

    # Add suggestions or plain prompt
    if recent_activities:
        text += (
            "–í—ã–±–µ—Ä–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—ë (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞).\n"
            "–ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ #—Ö–µ—à—Ç–µ–≥"
        )
        keyboard = get_recent_activities_keyboard(recent_activities)
    else:
        text += (
            "–ù–∞–ø–∏—à–∏, —á–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞).\n"
            "–ú–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ #—Ö–µ—à—Ç–µ–≥"
        )
        keyboard = None

    logger.debug(
        "Built description prompt",
        extra={
            "user_id": user_id,
            "category_id": category_id,
            "recent_activities_count": len(recent_activities),
            "has_keyboard": keyboard is not None
        }
    )

    return text, keyboard
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] Docstring –ø–æ–ª–Ω—ã–π
- [ ] Error handling –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ

**–ù–∞–ø–∏—Å–∞—Ç—å unit tests:**

```python
# –í tests/unit/handlers/test_shared.py

import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from datetime import datetime
from src.api.handlers.activity.shared import fetch_and_build_description_prompt


class TestFetchAndBuildDescriptionPrompt:
    """Tests for fetch_and_build_description_prompt function."""

    @pytest.mark.asyncio
    async def test_with_recent_activities(self):
        """Test prompt building with recent activities."""
        # Mock services
        services = MagicMock()
        services.activity.get_user_activities_by_category = AsyncMock(
            return_value={
                "activities": [
                    {"id": 1, "description": "–†–∞–±–æ—Ç–∞"},
                    {"id": 2, "description": "–í—Å—Ç—Ä–µ—á–∞"}
                ]
            }
        )

        start_time = datetime(2025, 11, 11, 10, 0)
        end_time = datetime(2025, 11, 11, 12, 0)

        with patch('src.api.handlers.activity.shared.get_recent_activities_keyboard') as mock_keyboard:
            mock_keyboard.return_value = MagicMock()

            text, keyboard = await fetch_and_build_description_prompt(
                services, user_id=123, category_id=456,
                start_time=start_time, end_time=end_time
            )

        # Assertions
        assert "‚úèÔ∏è –û–ø–∏—à–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" in text
        assert "10:00" in text
        assert "12:00" in text
        assert "2—á" in text
        assert "–í—ã–±–µ—Ä–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö" in text
        assert keyboard is not None

        # Verify API was called correctly
        services.activity.get_user_activities_by_category.assert_called_once_with(
            user_id=123,
            category_id=456,
            limit=20
        )

    @pytest.mark.asyncio
    async def test_without_recent_activities(self):
        """Test prompt building without recent activities."""
        services = MagicMock()
        services.activity.get_user_activities_by_category = AsyncMock(
            return_value={"activities": []}
        )

        start_time = datetime(2025, 11, 11, 10, 0)
        end_time = datetime(2025, 11, 11, 12, 0)

        text, keyboard = await fetch_and_build_description_prompt(
            services, user_id=123, category_id=456,
            start_time=start_time, end_time=end_time
        )

        assert "‚úèÔ∏è –û–ø–∏—à–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" in text
        assert "–ù–∞–ø–∏—à–∏, —á–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è" in text
        assert keyboard is None

    @pytest.mark.asyncio
    async def test_api_error_handling(self):
        """Test graceful error handling when API call fails."""
        services = MagicMock()
        services.activity.get_user_activities_by_category = AsyncMock(
            side_effect=Exception("API Error")
        )

        start_time = datetime(2025, 11, 11, 10, 0)
        end_time = datetime(2025, 11, 11, 12, 0)

        # Should not raise, should handle gracefully
        text, keyboard = await fetch_and_build_description_prompt(
            services, user_id=123, category_id=456,
            start_time=start_time, end_time=end_time
        )

        # Should return prompt without suggestions
        assert "‚úèÔ∏è –û–ø–∏—à–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å" in text
        assert keyboard is None

    @pytest.mark.asyncio
    async def test_custom_limit(self):
        """Test with custom limit parameter."""
        services = MagicMock()
        services.activity.get_user_activities_by_category = AsyncMock(
            return_value={"activities": []}
        )

        start_time = datetime(2025, 11, 11, 10, 0)
        end_time = datetime(2025, 11, 11, 12, 0)

        await fetch_and_build_description_prompt(
            services, user_id=123, category_id=456,
            start_time=start_time, end_time=end_time,
            limit=50
        )

        # Verify custom limit was used
        services.activity.get_user_activities_by_category.assert_called_once_with(
            user_id=123,
            category_id=456,
            limit=50
        )
```

**–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã:**
```bash
pytest tests/unit/handlers/test_shared.py::TestFetchAndBuildDescriptionPrompt -v
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Coverage –≤—ã—Å–æ–∫–∏–π (>90%)

---

## ‚úÖ TODO 3.4: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å create_and_save_activity()

**–î–æ–±–∞–≤–∏—Ç—å –≤ shared.py:**

```python
async def create_and_save_activity(
    message: types.Message,
    state: FSMContext,
    services: ServiceContainer,
    telegram_user_id: int,
    description: str,
    tags: list[str],
    post_save_callback: Callable[[dict], Awaitable[None]] | None = None
) -> bool:
    """Create and save activity with validation and error handling.

    Handles the complete flow of saving an activity:
    1. Validates required state data
    2. Parses time strings to datetime objects
    3. Creates activity via API
    4. Calls optional post-save callback (e.g., scheduling next poll)
    5. Sends success message to user
    6. Clears FSM state and cancels timeout
    7. Handles all errors gracefully

    Args:
        message: Message object to send responses to
        state: FSM context containing user_id, category_id, start_time, end_time
        services: Service container with data access
        telegram_user_id: Telegram user ID for FSM timeout cancellation
        description: Activity description text (already validated)
        tags: List of hashtags extracted from description
        post_save_callback: Optional async callback(state_data) called after
                           successful save. Used for flow-specific actions like
                           scheduling next poll. State data dict is passed.

    Returns:
        True if activity was saved successfully, False otherwise

    Examples:
        # Manual flow (no callback)
        >>> success = await create_and_save_activity(
        ...     message, state, services, telegram_id,
        ...     description="–†–∞–±–æ—Ç–∞", tags=["—Ä–∞–±–æ—Ç–∞"]
        ... )

        # Automatic poll flow (with callback)
        >>> async def schedule_next_poll(data: dict):
        ...     await services.scheduler.schedule_poll(
        ...         user_id=telegram_id,
        ...         settings=data["settings"],
        ...         user_timezone=data["user_timezone"],
        ...         send_poll_callback=send_automatic_poll,
        ...         bot=message.bot
        ...     )
        >>>
        >>> success = await create_and_save_activity(
        ...     message, state, services, telegram_id,
        ...     description="–í—Å—Ç—Ä–µ—á–∞", tags=["—Ä–∞–±–æ—Ç–∞"],
        ...     post_save_callback=schedule_next_poll
        ... )

    Note:
        All user-facing messages are in Russian.
        Errors are logged with context for debugging.
    """
    # Get data from state
    data = await state.get_data()
    user_id = data.get("user_id")
    category_id = data.get("category_id")
    start_time_str = data.get("start_time")
    end_time_str = data.get("end_time")

    # Validate required data
    if not all([user_id, category_id, start_time_str, end_time_str, description]):
        logger.warning(
            "Insufficient data for saving activity",
            extra={
                "has_user_id": user_id is not None,
                "has_category_id": category_id is not None,
                "has_start_time": start_time_str is not None,
                "has_end_time": end_time_str is not None,
                "has_description": bool(description)
            }
        )
        await message.answer(
            "‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()
        return False

    try:
        # Parse time strings
        start_time = datetime.fromisoformat(start_time_str)
        end_time = datetime.fromisoformat(end_time_str)

        # Create activity
        await services.activity.create_activity(
            user_id=user_id,
            category_id=category_id,
            description=description,
            tags=tags,
            start_time=start_time,
            end_time=end_time
        )

        logger.info(
            "Activity created successfully",
            extra={
                "user_id": user_id,
                "category_id": category_id,
                "duration_minutes": int((end_time - start_time).total_seconds() / 60),
                "has_post_save_callback": post_save_callback is not None
            }
        )

        # Call post-save callback if provided (e.g., schedule next poll)
        if post_save_callback:
            try:
                await post_save_callback(data)
                logger.debug("Post-save callback executed successfully")
            except Exception as callback_error:
                logger.error(
                    "Error in post-save callback",
                    extra={"error": str(callback_error)},
                    exc_info=True
                )
                # Don't fail the whole operation if callback fails
                # Activity is already saved at this point

        # Format success message
        duration_minutes = int((end_time - start_time).total_seconds() / 60)
        duration_str = format_duration(duration_minutes)

        success_message = (
            f"‚úÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n\n"
            f"{description}\n"
            f"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_str}"
        )

        # Add poll-specific message if callback was provided
        if post_save_callback:
            success_message += "\n\n–°–ª–µ–¥—É—é—â–∏–π –æ–ø—Ä–æ—Å –ø—Ä–∏–¥—ë—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é."

        await message.answer(success_message, reply_markup=get_main_menu_keyboard())

        # Clear state and timeout
        await state.clear()

        if fsm_timeout_module.fsm_timeout_service:
            fsm_timeout_module.fsm_timeout_service.cancel_timeout(telegram_user_id)

        return True

    except Exception as e:
        logger.error(
            "Error saving activity",
            extra={
                "user_id": user_id,
                "telegram_user_id": telegram_user_id,
                "error": str(e)
            },
            exc_info=True
        )

        await message.answer(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()

        if fsm_timeout_module.fsm_timeout_service:
            fsm_timeout_module.fsm_timeout_service.cancel_timeout(telegram_user_id)

        return False
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] Docstring –ø–æ–ª–Ω—ã–π —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- [ ] Error handling –ø–æ–ª–Ω—ã–π
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö

**–ù–∞–ø–∏—Å–∞—Ç—å unit tests** (–¥–æ–±–∞–≤–∏—Ç—å –≤ test_shared.py) - –∏–∑-–∑–∞ –¥–ª–∏–Ω—ã –æ–ø—É—â–µ–Ω–æ, –Ω–æ –¥–æ–ª–∂–Ω—ã –ø–æ–∫—Ä—ã–≤–∞—Ç—å:
- –£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–µ–∑ callback
- –£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å callback
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
- –û—à–∏–±–∫–∞ API
- –û—à–∏–±–∫–∞ –≤ callback (–Ω–µ –¥–æ–ª–∂–Ω–∞ –ª–æ–º–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π flow)

---

## ‚úÖ TODO 3.5: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –§–∞–∑—ã 3

```bash
git add src/api/handlers/activity/shared.py
git add tests/unit/handlers/test_shared.py

git commit -m "feat(handlers): add shared module for activity recording

- Add validate_description() for input validation
- Add fetch_and_build_description_prompt() for building prompts
- Add create_and_save_activity() for unified save logic
- Add comprehensive unit tests with >90% coverage

These functions eliminate code duplication between manual and
automatic poll flows."
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

# üéØ –§–ê–ó–ê 4: –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø –†–£–ß–ù–û–ì–û –ü–û–¢–û–ö–ê

**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô
**–†–∏—Å–∫:** üü° –°–†–ï–î–ù–ò–ô

## –¶–µ–ª—å
–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ê–≤—Ç–æ" –≤ —Ä—É—á–Ω–æ–π –ø–æ—Ç–æ–∫ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å shared —Ñ—É–Ω–∫—Ü–∏–∏.

---

## ‚úÖ TODO 4.1: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ê–≤—Ç–æ" –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–µ—Ä–∏–æ–¥–∞

**–§–∞–π–ª:** `src/api/keyboards/time_select.py`

**–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é:**

```python
def get_period_keyboard_with_auto() -> InlineKeyboardMarkup:
    """Period keyboard with 'Auto Calculate' button for manual flow.

    Provides quick-select period buttons plus an option to automatically
    calculate period from last activity (similar to automatic poll behavior).

    Returns:
        InlineKeyboardMarkup with auto-calculate option and period buttons

    Layout:
        [‚ö°Ô∏è –ê–≤—Ç–æ (–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)]
        [‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –≤—Ä—É—á–Ω—É—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ]
        [15 –º–∏–Ω—É—Ç] [30 –º–∏–Ω—É—Ç]
        [1 —á–∞—Å]    [3 —á–∞—Å–∞]
        [8 —á–∞—Å–æ–≤]  [12 —á–∞—Å–æ–≤]
        [‚ùå –û—Ç–º–µ–Ω–∏—Ç—å]
    """
    from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup

    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        # Auto-calculate option (prominent at top)
        [InlineKeyboardButton(
            text="‚ö°Ô∏è –ê–≤—Ç–æ (–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)",
            callback_data="period_auto"
        )],
        # Visual divider (non-clickable)
        [InlineKeyboardButton(
            text="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –≤—Ä—É—á–Ω—É—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
            callback_data="noop"
        )],
        # Quick period selection buttons (2x3 grid)
        [
            InlineKeyboardButton(text="15 –º–∏–Ω—É—Ç", callback_data="period_15m"),
            InlineKeyboardButton(text="30 –º–∏–Ω—É—Ç", callback_data="period_30m"),
        ],
        [
            InlineKeyboardButton(text="1 —á–∞—Å", callback_data="period_1h"),
            InlineKeyboardButton(text="3 —á–∞—Å–∞", callback_data="period_3h"),
        ],
        [
            InlineKeyboardButton(text="8 —á–∞—Å–æ–≤", callback_data="period_8h"),
            InlineKeyboardButton(text="12 —á–∞—Å–æ–≤", callback_data="period_12h"),
        ],
        # Cancel button
        [InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel")],
    ])
    return keyboard
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] Docstring –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] Layout –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–¢–µ—Å—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ tests/manual_testing/test_keyboards.py
def test_period_keyboard_visual():
    """Visual test for period keyboard with auto button."""
    from src.api.keyboards.time_select import get_period_keyboard_with_auto

    keyboard = get_period_keyboard_with_auto()

    # Print –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
    for row in keyboard.inline_keyboard:
        print([btn.text for btn in row])

    # Should have 7 rows
    assert len(keyboard.inline_keyboard) == 7
    # First row should be auto button
    assert keyboard.inline_keyboard[0][0].text == "‚ö°Ô∏è –ê–≤—Ç–æ (–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)"
```

---

## ‚úÖ TODO 4.2: –û–±–Ω–æ–≤–∏—Ç—å start_add_activity() –¥–ª—è –Ω–æ–≤–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

**–§–∞–π–ª:** `src/api/handlers/activity/activity_creation.py`

**–ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é start_add_activity() –∏ –æ–±–Ω–æ–≤–∏—Ç—å:**

```python
@router.callback_query(F.data == "add_activity")
@with_typing_action
@log_user_action("add_activity_started")
async def start_add_activity(callback: types.CallbackQuery, state: FSMContext):
    """Start activity recording - MANUAL trigger.

    Entry point for manual activity recording. Presents user with period
    selection screen including new auto-calculate option.
    """
    logger.debug(
        "Starting manual activity creation",
        extra={
            "user_id": callback.from_user.id,
            "username": callback.from_user.username
        }
    )

    # Set FSM state
    await state.set_state(ActivityStates.waiting_for_period)

    # Mark as manual trigger (important for shared handlers)
    await state.update_data(trigger_source="manual")

    # Schedule FSM timeout
    if fsm_timeout_module.fsm_timeout_service:
        fsm_timeout_module.fsm_timeout_service.schedule_timeout(
            user_id=callback.from_user.id,
            state=ActivityStates.waiting_for_period,
            bot=callback.bot
        )

    # Build message text
    text = (
        "‚è∞ –ó–ê–î–ê–ô –ü–ï–†–ò–û–î\n\n"
        "üëá –í—ã–±–µ—Ä–∏ –∫–Ω–æ–ø–∫–æ–π –Ω–∏–∂–µ\n"
        "–∏–ª–∏\n"
        "‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º:\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ 30–º ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç\n"
        "‚Ä¢ 2—á ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞\n"
        "‚Ä¢ 14:30 ‚Äî 15:30 ‚Äî —Ç–æ—á–Ω—ã–π –ø–µ—Ä–∏–æ–¥\n\n"
        "üí° –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∞–≤—Ç–æ-—Ä–∞—Å—á—ë—Ç –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
    )

    # Use new keyboard with Auto button
    from src.api.keyboards.time_select import get_period_keyboard_with_auto

    await callback.message.answer(text, reply_markup=get_period_keyboard_with_auto())
    await callback.answer()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] `trigger_source="manual"` –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –ù–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- [ ] –¢–µ–∫—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω

---

## ‚úÖ TODO 4.3: –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ê–≤—Ç–æ"

**–î–æ–±–∞–≤–∏—Ç—å –≤ activity_creation.py:**

```python
@router.callback_query(ActivityStates.waiting_for_period, F.data == "period_auto")
@with_typing_action
async def auto_calculate_period(
    callback: types.CallbackQuery,
    state: FSMContext,
    services: ServiceContainer
):
    """Auto-calculate period from last activity (manual flow).

    Uses the same logic as automatic polls to calculate the time range
    based on the user's last recorded activity end time. If no previous
    activity exists, falls back to default poll interval.

    This provides convenience for users who want quick recording without
    manually entering a period.
    """
    telegram_id = callback.from_user.id

    try:
        # Get user
        user = await services.user.get_by_telegram_id(telegram_id)
        if not user:
            logger.warning(
                "User not found for auto period calculation",
                extra={"telegram_id": telegram_id}
            )
            await callback.message.answer(
                "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                reply_markup=get_main_menu_keyboard()
            )
            await state.clear()
            await callback.answer()
            return

        # Get settings
        settings = await services.settings.get_settings(user["id"])

        # Auto-calculate period using same logic as polls
        from src.application.utils.time_helpers import calculate_poll_period

        start_time, end_time = await calculate_poll_period(
            services.activity,
            user["id"],
            settings
        )

        logger.info(
            "Auto-calculated period for manual flow",
            extra={
                "user_id": user["id"],
                "start_time": start_time.isoformat(),
                "end_time": end_time.isoformat(),
                "duration_minutes": int((end_time - start_time).total_seconds() / 60)
            }
        )

        # Format for display
        from src.application.utils.formatters import format_time, format_duration

        start_str = format_time(start_time)
        end_str = format_time(end_time)
        duration_minutes = int((end_time - start_time).total_seconds() / 60)
        duration_str = format_duration(duration_minutes)

        # Store in FSM
        await state.update_data(
            start_time=start_time.isoformat(),
            end_time=end_time.isoformat(),
            user_id=user["id"]
        )

        # Move to category selection
        await state.set_state(ActivityStates.waiting_for_category)

        # Schedule FSM timeout
        if fsm_timeout_module.fsm_timeout_service:
            fsm_timeout_module.fsm_timeout_service.schedule_timeout(
                user_id=telegram_id,
                state=ActivityStates.waiting_for_category,
                bot=callback.bot
            )

        # Get categories
        categories = await services.category.get_user_categories(user["id"])

        if not categories:
            await callback.message.answer(
                "üìÇ –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π.\n\n"
                "–°–æ–∑–¥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ —Ä–∞–∑–¥–µ–ª–µ '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏'.",
                reply_markup=get_main_menu_keyboard()
            )
            await state.clear()
            await callback.answer()
            return

        # Show category selection
        from src.api.handlers.activity.messages import get_category_selection_message
        from src.api.keyboards.category import get_category_keyboard

        text = get_category_selection_message(
            source="manual_auto",
            start_time=start_str,
            end_time=end_str,
            duration=duration_str,
            add_motivation=True
        )

        await callback.message.answer(
            text,
            reply_markup=get_category_keyboard(categories, source="manual")
        )
        await callback.answer()

    except Exception as e:
        logger.error(
            "Error in auto_calculate_period",
            extra={
                "telegram_id": telegram_id,
                "error": str(e)
            },
            exc_info=True
        )
        await callback.message.answer(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–∞—Å—á—ë—Ç–µ –ø–µ—Ä–∏–æ–¥–∞.\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –≤—Ä—É—á–Ω—É—é.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()
        await callback.answer()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Handler —Å–æ–∑–¥–∞–Ω
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `calculate_poll_period()`
- [ ] Error handling –ø–æ–ª–Ω—ã–π
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- [ ] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç edge cases (–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π)

---

## ‚úÖ TODO 4.4: –î–æ–±–∞–≤–∏—Ç—å handler –¥–ª—è "noop" callback

**–î–æ–±–∞–≤–∏—Ç—å –≤ activity_creation.py:**

```python
@router.callback_query(F.data == "noop")
async def handle_noop(callback: types.CallbackQuery):
    """Handle no-operation callback.

    Used for visual dividers in keyboards (non-clickable buttons).
    Simply acknowledges the callback without any action.
    """
    await callback.answer()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Handler –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –ü—Ä–æ—Å—Ç–æ–π –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π

---

## ‚úÖ TODO 4.5: –û–±–Ω–æ–≤–∏—Ç—å process_period_text() –¥–ª—è trigger_source

**–ù–∞–π—Ç–∏ –∏ –æ–±–Ω–æ–≤–∏—Ç—å:**

```python
@router.message(ActivityStates.waiting_for_period)
async def process_period_text(
    message: types.Message,
    state: FSMContext,
    services: ServiceContainer
):
    """Process text period input (manual flow)."""
    period_str = message.text.strip()
    telegram_id = message.from_user.id

    # Ensure trigger_source is set (defensive programming)
    data = await state.get_data()
    if "trigger_source" not in data:
        await state.update_data(trigger_source="manual")
        logger.debug(
            "Set trigger_source to manual (was missing)",
            extra={"telegram_id": telegram_id}
        )

    # ... rest of existing logic unchanged ...
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] `trigger_source` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- [ ] Existing logic –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞

---

## ‚úÖ TODO 4.6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 4

**–ù–∞–ø–∏—Å–∞—Ç—å integration test:**

```python
# –í tests/integration/test_activity_flows.py

@pytest.mark.asyncio
async def test_manual_flow_with_auto_period():
    """Test manual flow using auto period calculation button."""
    # Setup
    bot, dp, storage = await setup_test_bot()
    user_id = 12345

    # Step 1: Start manual recording
    callback = create_mock_callback(user_id, data="add_activity")
    await start_add_activity(callback, storage.get_state(...))

    # Verify: FSM state is waiting_for_period
    state_data = await storage.get_data(...)
    assert state_data["trigger_source"] == "manual"

    # Step 2: Click "–ê–≤—Ç–æ" button
    callback = create_mock_callback(user_id, data="period_auto")
    await auto_calculate_period(callback, storage.get_state(...), services)

    # Verify: Period auto-calculated
    state_data = await storage.get_data(...)
    assert "start_time" in state_data
    assert "end_time" in state_data

    # Verify: FSM state moved to waiting_for_category
    current_state = await storage.get_state(...)
    assert current_state == ActivityStates.waiting_for_category

    # Step 3: Select category
    # Step 4: Enter description
    # Step 5: Verify activity saved WITHOUT next poll scheduled
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Integration test –Ω–∞–ø–∏—Å–∞–Ω
- [ ] –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –≤–µ—Å—å flow —Å –∫–Ω–æ–ø–∫–æ–π "–ê–≤—Ç–æ"

---

## ‚úÖ TODO 4.7: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –§–∞–∑—ã 4

```bash
git add src/api/keyboards/time_select.py
git add src/api/handlers/activity/activity_creation.py
git add tests/integration/test_activity_flows.py

git commit -m "feat(manual-flow): add auto period calculation button

- Add 'Auto' button to period selection keyboard
- Implement auto_calculate_period() handler
- Update start_add_activity() to use new keyboard
- Add noop callback handler for visual dividers
- Ensure trigger_source is set throughout manual flow

Users can now auto-calculate period from last activity in manual flow."
```

---

# üéØ –§–ê–ó–ê 5: –ú–û–î–ò–§–ò–ö–ê–¶–ò–Ø –ê–í–¢–û–û–ü–†–û–°–ê

**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô
**–†–∏—Å–∫:** üü° –°–†–ï–î–ù–ò–ô

## –¶–µ–ª—å
–û–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è shared handlers.

---

## ‚úÖ TODO 5.1: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å send_automatic_poll()

**–§–∞–π–ª:** `src/api/handlers/poll/poll_sender.py`

**–ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é:**

```python
async def send_automatic_poll(bot: Bot, user_id: int) -> None:
    """Send automatic poll - SKIPS period selection, goes directly to category.

    This is the entry point for automatic polls triggered by the scheduler.
    It calculates the activity period automatically (from last activity end time)
    and presents the user with category selection immediately, skipping the
    period selection screen entirely.

    Args:
        bot: Telegram Bot instance
        user_id: Telegram user ID (not internal user ID)

    Flow:
        1. Get user, settings, categories
        2. Check for FSM conflicts (user might be in another flow)
        3. Auto-calculate period from last activity
        4. Set FSM state directly to waiting_for_category (SKIP period step)
        5. Store period and context in FSM data
        6. Send category selection message

    Note:
        If user is already in another FSM state, poll is postponed.
    """
    services = get_service_container()

    try:
        # Get user
        user = await services.user.get_by_telegram_id(user_id)
        if not user:
            logger.error(
                "User not found for automatic poll",
                extra={"telegram_user_id": user_id}
            )
            return

        # Get settings
        settings = await services.settings.get_settings(user["id"])
        if not settings:
            logger.warning(
                "Settings not found for user, using defaults",
                extra={"user_id": user["id"]}
            )
            settings = {}  # Will use default values

        # Get categories
        categories = await services.category.get_user_categories(user["id"])
        if not categories:
            logger.warning(
                "No categories for user, skipping poll",
                extra={"user_id": user["id"]}
            )
            # Don't send poll if no categories - nothing to select
            return

        # Check for FSM conflicts (user might be in manual recording flow)
        if await _should_postpone_poll(bot, user_id, services):
            logger.info(
                "Postponing poll due to FSM conflict",
                extra={"user_id": user_id}
            )
            await _postpone_poll(bot, user_id, services, settings)
            return

        # Auto-calculate period from last activity
        from src.application.utils.time_helpers import calculate_poll_period

        start_time, end_time = await calculate_poll_period(
            services.activity,
            user["id"],
            settings
        )

        logger.info(
            "Auto-calculated period for automatic poll",
            extra={
                "user_id": user["id"],
                "start_time": start_time.isoformat(),
                "end_time": end_time.isoformat(),
                "duration_minutes": int((end_time - start_time).total_seconds() / 60)
            }
        )

        # Set FSM state DIRECTLY to category selection (SKIP period step)
        storage = get_fsm_storage()
        key = StorageKey(bot_id=bot.id, chat_id=user_id, user_id=user_id)

        await storage.set_state(key, ActivityStates.waiting_for_category)

        # Store period and context in FSM data
        await storage.update_data(key, {
            "trigger_source": "automatic",  # Mark as automatic flow
            "start_time": start_time.isoformat(),
            "end_time": end_time.isoformat(),
            "user_id": user["id"],
            "settings": settings,  # Needed for scheduling next poll
            "user_timezone": user.get("timezone", "Europe/Moscow")  # Needed for scheduling
        })

        # Schedule FSM timeout
        from src.application.services import fsm_timeout_service as fsm_timeout_module
        if fsm_timeout_module.fsm_timeout_service:
            fsm_timeout_module.fsm_timeout_service.schedule_timeout(
                user_id=user_id,
                state=ActivityStates.waiting_for_category,
                bot=bot
            )

        # Format time for display
        from src.application.utils.formatters import format_time, format_duration

        start_str = format_time(start_time)
        end_str = format_time(end_time)
        duration_minutes = int((end_time - start_time).total_seconds() / 60)
        duration_str = format_duration(duration_minutes)

        # Build category selection message
        from src.api.handlers.activity.messages import get_category_selection_message

        text = get_category_selection_message(
            source="poll",
            start_time=start_str,
            end_time=end_str,
            duration=duration_str,
            add_motivation=True
        )

        # Send message with categories (use poll-specific keyboard)
        from src.api.keyboards.category import get_poll_category_keyboard

        await bot.send_message(
            chat_id=user_id,
            text=text,
            reply_markup=get_poll_category_keyboard(categories)
        )

        # Update last poll time
        await _update_last_poll_time(services, user, user_id)

        logger.info(
            "Sent automatic poll successfully",
            extra={
                "user_id": user_id,
                "categories_count": len(categories)
            }
        )

    except Exception as e:
        logger.error(
            "Error sending automatic poll",
            extra={
                "user_id": user_id,
                "error": str(e)
            },
            exc_info=True
        )
        # Don't propagate exception - scheduler should continue
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç state –Ω–∞ `ActivityStates.waiting_for_category` (–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç period)
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç `trigger_source="automatic"`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `settings` –∏ `user_timezone` –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–ø—Ä–æ—Å–∞
- ‚úÖ –ü–æ–ª–Ω—ã–π error handling

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `ActivityStates`
- [ ] –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç period step
- [ ] –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ state
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–µ

---

## ‚úÖ TODO 5.2: –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ handlers –∏–∑ poll_response.py

**–§–∞–π–ª:** `src/api/handlers/poll/poll_response.py`

**–£–¥–∞–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ handlers (–æ–Ω–∏ –±—É–¥—É—Ç –≤ shared):**

```python
# DELETE THIS HANDLER - will use shared from activity_creation.py
@router.callback_query(ActivityStates.waiting_for_category, F.data.startswith("poll_category_"))
async def handle_poll_category_select(...):
    # DELETE ENTIRE FUNCTION
    pass

# DELETE THIS HANDLER - will use shared from activity_creation.py
@router.callback_query(ActivityStates.waiting_for_description, F.data.startswith("activity_desc_"))
async def handle_poll_recent_activity_select(...):
    # DELETE ENTIRE FUNCTION
    pass

# DELETE THIS HANDLER - will use shared from activity_creation.py
@router.message(ActivityStates.waiting_for_description)
async def handle_poll_description(...):
    # DELETE ENTIRE FUNCTION
    pass
```

**–û—Å—Ç–∞–≤–∏—Ç—å:**
```python
# KEEP THIS - poll-specific cancel handler
@router.callback_query(ActivityStates.waiting_for_category, F.data == "poll_cancel")
async def handle_poll_cancel(...):
    # KEEP - —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è poll flow
    pass
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –î—É–±–ª–∏—Ä—É—é—â–∏–µ handlers —É–¥–∞–ª–µ–Ω—ã
- [ ] `handle_poll_cancel` –æ—Å—Ç–∞–≤–ª–µ–Ω
- [ ] Helper functions –æ—Å—Ç–∞–≤–ª–µ–Ω—ã (_should_postpone_poll, etc.)

---

## ‚úÖ TODO 5.3: –û–±–Ω–æ–≤–∏—Ç—å handle_poll_cancel

**–§–∞–π–ª:** `src/api/handlers/poll/poll_response.py`

**–û–±–Ω–æ–≤–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ trigger_source:**

```python
@router.callback_query(ActivityStates.waiting_for_category, F.data == "poll_cancel")
async def handle_poll_cancel(callback: types.CallbackQuery, state: FSMContext):
    """Handle poll cancellation - specific to automatic polls.

    Only processes cancellation if this is actually an automatic poll
    (verified via trigger_source). Manual flow uses different cancel callback.
    """
    telegram_id = callback.from_user.id

    # Get state data
    data = await state.get_data()
    trigger_source = data.get("trigger_source", "manual")

    # Only handle if this is actually an automatic poll
    if trigger_source != "automatic":
        logger.warning(
            "poll_cancel called but not in automatic flow",
            extra={
                "telegram_id": telegram_id,
                "trigger_source": trigger_source
            }
        )
        await callback.answer("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π –¥—Ä—É–≥—É—é –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã")
        return

    # Clear FSM state
    await state.clear()

    # Cancel FSM timeout
    from src.application.services import fsm_timeout_service as fsm_timeout_module
    if fsm_timeout_module.fsm_timeout_service:
        fsm_timeout_module.fsm_timeout_service.cancel_timeout(telegram_id)

    # Send cancellation message
    from src.api.keyboards.main_menu import get_main_menu_keyboard

    await callback.message.answer(
        "‚ùå –û–ø—Ä–æ—Å –æ—Ç–º–µ–Ω—ë–Ω.\n\n"
        "–°–ª–µ–¥—É—é—â–∏–π –æ–ø—Ä–æ—Å –ø—Ä–∏–¥—ë—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.",
        reply_markup=get_main_menu_keyboard()
    )

    await callback.answer()

    logger.info(
        "Automatic poll cancelled by user",
        extra={"telegram_id": telegram_id}
    )
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `trigger_source`
- [ ] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç edge case (–Ω–µ automatic)
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ

---

## ‚úÖ TODO 5.4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 5

**–ù–∞–ø–∏—Å–∞—Ç—å integration test:**

```python
# –í tests/integration/test_activity_flows.py

@pytest.mark.asyncio
async def test_automatic_poll_flow():
    """Test automatic poll flow: skips period, shows category directly."""
    # Setup
    bot, dp, storage = await setup_test_bot()
    user_id = 12345

    # Mock last activity
    mock_last_activity(user_id, end_time=datetime.now() - timedelta(hours=2))

    # Step 1: Trigger automatic poll
    await send_automatic_poll(bot, user_id)

    # Verify: FSM state is waiting_for_category (NOT waiting_for_period!)
    state = await storage.get_state(...)
    assert state == ActivityStates.waiting_for_category

    # Verify: trigger_source is automatic
    state_data = await storage.get_data(...)
    assert state_data["trigger_source"] == "automatic"

    # Verify: period was auto-calculated
    assert "start_time" in state_data
    assert "end_time" in state_data
    assert "settings" in state_data
    assert "user_timezone" in state_data

    # Step 2: Select category
    callback = create_mock_callback(user_id, data="poll_category_1")
    await process_category_callback(callback, storage.get_state(...), services)

    # Step 3: Enter description
    message = create_mock_message(user_id, text="–†–∞–±–æ—Ç–∞")
    await process_description(message, storage.get_state(...), services)

    # Verify: Activity saved
    activities = await get_activities(user_id)
    assert len(activities) == 1

    # Verify: Next poll scheduled
    next_poll = await get_next_scheduled_poll(user_id)
    assert next_poll is not None
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Integration test –Ω–∞–ø–∏—Å–∞–Ω
- [ ] –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –≤–µ—Å—å automatic poll flow

---

## ‚úÖ TODO 5.5: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –§–∞–∑—ã 5

```bash
git add src/api/handlers/poll/poll_sender.py
git add src/api/handlers/poll/poll_response.py
git add tests/integration/test_activity_flows.py

git commit -m "refactor(poll): skip period selection in automatic polls

- Rewrite send_automatic_poll() to skip period selection
- Set FSM state directly to waiting_for_category
- Remove duplicate handlers from poll_response.py
- Update handle_poll_cancel to verify trigger_source
- Store settings and timezone for next poll scheduling

Automatic polls now use shared handlers from activity_creation.py."
```

---

# üéØ –§–ê–ó–ê 6: –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï HANDLERS

**–í—Ä–µ–º—è:** 4-5 —á–∞—Å–æ–≤
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–†–∏—Å–∫:** üü° –°–†–ï–î–ù–ò–ô

## –¶–µ–ª—å
–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å handlers –≤ activity_creation.py –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è shared —Ñ—É–Ω–∫—Ü–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–æ–∏—Ö flows.

---

## ‚úÖ TODO 6.1: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å process_category_callback() –¥–ª—è –æ–±–æ–∏—Ö flows

**–§–∞–π–ª:** `src/api/handlers/activity/activity_creation.py`

**–ù–∞–π—Ç–∏ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å:**

```python
@router.callback_query(ActivityStates.waiting_for_category, F.data.startswith("poll_category_"))
@router.callback_query(ActivityStates.waiting_for_category, F.data.startswith("activity_category_"))
@with_typing_action
async def process_category_callback(
    callback: types.CallbackQuery,
    state: FSMContext,
    services: ServiceContainer
):
    """Handle category selection - SHARED by manual and automatic flows.

    This handler processes category selection from both manual activity
    recording and automatic poll responses. Flow differentiation happens
    via trigger_source in FSM state data.

    Callback data formats:
        - poll_category_{id} - from automatic polls
        - activity_category_{id} - from manual recording

    Both formats are supported for backward compatibility.
    """
    telegram_id = callback.from_user.id

    try:
        # Parse category ID from callback data
        callback_data = callback.data
        if callback_data.startswith("poll_category_"):
            category_id = int(callback_data.replace("poll_category_", ""))
        elif callback_data.startswith("activity_category_"):
            category_id = int(callback_data.replace("activity_category_", ""))
        else:
            logger.warning(
                "Invalid callback data format",
                extra={"callback_data": callback_data}
            )
            await callback.answer("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞")
            return

        # Get state data
        data = await state.get_data()
        user_id = data.get("user_id")
        start_time_str = data.get("start_time")
        end_time_str = data.get("end_time")
        trigger_source = data.get("trigger_source", "manual")

        # Validate required data
        if not all([user_id, start_time_str, end_time_str]):
            logger.error(
                "Missing required data for category selection",
                extra={
                    "has_user_id": user_id is not None,
                    "has_start_time": start_time_str is not None,
                    "has_end_time": end_time_str is not None,
                    "trigger_source": trigger_source
                }
            )
            await callback.message.answer(
                "‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö. –ù–∞—á–Ω–∏ –∑–∞–ø–∏—Å—å –∑–∞–Ω–æ–≤–æ.",
                reply_markup=get_main_menu_keyboard()
            )
            await state.clear()
            await callback.answer()
            return

        # Parse times
        start_time = datetime.fromisoformat(start_time_str)
        end_time = datetime.fromisoformat(end_time_str)

        # Store category_id
        await state.update_data(category_id=category_id)

        # Move to description state
        await state.set_state(ActivityStates.waiting_for_description)

        # Schedule FSM timeout
        if fsm_timeout_module.fsm_timeout_service:
            fsm_timeout_module.fsm_timeout_service.schedule_timeout(
                user_id=telegram_id,
                state=ActivityStates.waiting_for_description,
                bot=callback.bot
            )

        # Fetch recent activities and build prompt using shared function
        from src.api.handlers.activity.shared import fetch_and_build_description_prompt

        text, keyboard = await fetch_and_build_description_prompt(
            services=services,
            user_id=user_id,
            category_id=category_id,
            start_time=start_time,
            end_time=end_time,
            limit=20
        )

        await callback.message.answer(text, reply_markup=keyboard)
        await callback.answer()

        logger.info(
            "Category selected successfully",
            extra={
                "user_id": user_id,
                "category_id": category_id,
                "trigger_source": trigger_source
            }
        )

    except ValueError as e:
        logger.error(
            "Invalid category ID format",
            extra={"callback_data": callback.data, "error": str(e)},
            exc_info=True
        )
        await callback.answer("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")

    except Exception as e:
        logger.error(
            "Error processing category selection",
            extra={
                "telegram_id": telegram_id,
                "callback_data": callback.data,
                "error": str(e)
            },
            exc_info=True
        )
        await callback.message.answer(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()
        await callback.answer()
```

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ callback —Ñ–æ—Ä–º–∞—Ç–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `fetch_and_build_description_prompt()` –∏–∑ shared
- ‚úÖ –ù–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç flows –Ω–∞–ø—Ä—è–º—É—é (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±–æ–∏—Ö)
- ‚úÖ –ü–æ–ª–Ω—ã–π error handling

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Handler –ø–µ—Ä–µ–ø–∏—Å–∞–Ω
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç shared —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±–∞ callback —Ñ–æ—Ä–º–∞—Ç–∞
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–µ

---

## ‚úÖ TODO 6.2: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å select_recent_activity() –¥–ª—è –æ–±–æ–∏—Ö flows

**–î–æ–±–∞–≤–∏—Ç—å –≤ activity_creation.py:**

```python
@router.callback_query(ActivityStates.waiting_for_description, F.data.startswith("activity_desc_"))
@with_typing_action
async def select_recent_activity(
    callback: types.CallbackQuery,
    state: FSMContext,
    services: ServiceContainer
):
    """Handle selection of recent activity - SHARED by manual and automatic flows.

    When user clicks on a recent activity suggestion button, this handler
    processes the selection and saves the activity.

    Callback data format: activity_desc_{activity_id}
    """
    telegram_id = callback.from_user.id

    try:
        # Parse activity ID from callback data
        activity_id = int(callback.data.replace("activity_desc_", ""))

        # Fetch the activity to get its description
        activity = await services.activity.get_activity(activity_id)
        if not activity:
            logger.warning(
                "Recent activity not found",
                extra={"activity_id": activity_id, "telegram_id": telegram_id}
            )
            await callback.answer("‚ö†Ô∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        description = activity.get("description", "")
        tags = activity.get("tags", [])

        logger.debug(
            "User selected recent activity",
            extra={
                "telegram_id": telegram_id,
                "activity_id": activity_id,
                "description": description
            }
        )

        # Get trigger source to determine if we need post-save callback
        data = await state.get_data()
        trigger_source = data.get("trigger_source", "manual")

        # Prepare post-save callback for automatic polls
        post_save_callback = None
        if trigger_source == "automatic":
            post_save_callback = _create_poll_scheduling_callback(
                telegram_id=telegram_id,
                bot=callback.bot
            )

        # Use shared save function
        from src.api.handlers.activity.shared import create_and_save_activity

        success = await create_and_save_activity(
            message=callback.message,
            state=state,
            services=services,
            telegram_user_id=telegram_id,
            description=description,
            tags=tags,
            post_save_callback=post_save_callback
        )

        await callback.answer("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" if success else "‚ö†Ô∏è –û—à–∏–±–∫–∞")

    except ValueError as e:
        logger.error(
            "Invalid activity ID format",
            extra={"callback_data": callback.data, "error": str(e)},
            exc_info=True
        )
        await callback.answer("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID")

    except Exception as e:
        logger.error(
            "Error processing recent activity selection",
            extra={
                "telegram_id": telegram_id,
                "callback_data": callback.data,
                "error": str(e)
            },
            exc_info=True
        )
        await callback.message.answer(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()
        await callback.answer()
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Handler —Å–æ–∑–¥–∞–Ω
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç shared `create_and_save_activity()`
- [ ] –†–∞–∑–ª–∏—á–∞–µ—Ç flows —á–µ—Ä–µ–∑ trigger_source
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç post_save_callback –¥–ª—è automatic

---

## ‚úÖ TODO 6.3: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å process_description() –¥–ª—è –æ–±–æ–∏—Ö flows

**–î–æ–±–∞–≤–∏—Ç—å –≤ activity_creation.py:**

```python
@router.message(ActivityStates.waiting_for_description)
async def process_description(
    message: types.Message,
    state: FSMContext,
    services: ServiceContainer
):
    """Handle description text input - SHARED by manual and automatic flows.

    Processes user's text input for activity description, validates it,
    extracts tags, and saves the activity using shared logic.
    """
    telegram_id = message.from_user.id
    description = message.text.strip()

    # Validate description using shared function
    from src.api.handlers.activity.shared import validate_description

    is_valid, error_msg = validate_description(description, min_length=3)
    if not is_valid:
        await message.answer(error_msg)
        return

    # Extract tags
    from src.application.utils.formatters import extract_tags
    tags = extract_tags(description)

    logger.debug(
        "Description validated",
        extra={
            "telegram_id": telegram_id,
            "description_length": len(description),
            "tags_count": len(tags)
        }
    )

    # Get trigger source to determine if we need post-save callback
    data = await state.get_data()
    trigger_source = data.get("trigger_source", "manual")

    # Prepare post-save callback for automatic polls
    post_save_callback = None
    if trigger_source == "automatic":
        post_save_callback = _create_poll_scheduling_callback(
            telegram_id=telegram_id,
            bot=message.bot
        )

    # Use shared save function
    from src.api.handlers.activity.shared import create_and_save_activity

    await create_and_save_activity(
        message=message,
        state=state,
        services=services,
        telegram_user_id=telegram_id,
        description=description,
        tags=tags,
        post_save_callback=post_save_callback
    )
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Handler –ø–µ—Ä–µ–ø–∏—Å–∞–Ω
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `validate_description()` –∏–∑ shared
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `create_and_save_activity()` –∏–∑ shared
- [ ] –†–∞–∑–ª–∏—á–∞–µ—Ç flows —á–µ—Ä–µ–∑ trigger_source

---

## ‚úÖ TODO 6.4: –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é _create_poll_scheduling_callback()

**–î–æ–±–∞–≤–∏—Ç—å –≤ activity_creation.py:**

```python
def _create_poll_scheduling_callback(telegram_id: int, bot: Bot) -> Callable[[dict], Awaitable[None]]:
    """Create post-save callback for scheduling next poll.

    Returns an async callback function that schedules the next automatic poll
    after activity is saved. Used only for automatic poll flow.

    Args:
        telegram_id: Telegram user ID
        bot: Bot instance for scheduling

    Returns:
        Async callback function that takes state_data dict
    """
    async def schedule_next_poll(state_data: dict) -> None:
        """Schedule next poll after activity save."""
        try:
            from src.api.handlers.poll.poll_sender import send_automatic_poll
            from src.application.services import scheduler_service

            settings = state_data.get("settings", {})
            user_timezone = state_data.get("user_timezone", "Europe/Moscow")

            # Schedule next poll
            if scheduler_service:
                await scheduler_service.schedule_poll(
                    user_id=telegram_id,
                    settings=settings,
                    user_timezone=user_timezone,
                    send_poll_callback=send_automatic_poll,
                    bot=bot
                )
                logger.info(
                    "Next poll scheduled successfully",
                    extra={"telegram_id": telegram_id}
                )
            else:
                logger.warning(
                    "Scheduler service not available",
                    extra={"telegram_id": telegram_id}
                )

        except Exception as e:
            logger.error(
                "Error scheduling next poll",
                extra={"telegram_id": telegram_id, "error": str(e)},
                exc_info=True
            )
            # Don't propagate - activity is already saved

    return schedule_next_poll
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç callback
- [ ] Error handling –ø–æ–ª–Ω—ã–π
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ

---

## ‚úÖ TODO 6.5: –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ activity_creation.py

**–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞:**

```python
from src.api.handlers.activity.shared import (
    validate_description,
    fetch_and_build_description_prompt,
    create_and_save_activity
)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ò–º–ø–æ—Ä—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤

---

## ‚úÖ TODO 6.6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§–∞–∑—ã 6

**–ù–∞–ø–∏—Å–∞—Ç—å comprehensive integration tests:**

```python
# –í tests/integration/test_activity_flows.py

@pytest.mark.asyncio
async def test_shared_handlers_manual_flow():
    """Test shared handlers work correctly for manual flow."""
    # Test that manual flow:
    # 1. Sets trigger_source="manual"
    # 2. Goes through all states
    # 3. Saves activity without scheduling next poll
    pass

@pytest.mark.asyncio
async def test_shared_handlers_automatic_flow():
    """Test shared handlers work correctly for automatic flow."""
    # Test that automatic flow:
    # 1. Sets trigger_source="automatic"
    # 2. Skips period state
    # 3. Saves activity and schedules next poll
    pass

@pytest.mark.asyncio
async def test_both_callback_formats_work():
    """Test both poll_category_X and activity_category_X work."""
    # Test backward compatibility
    pass

@pytest.mark.asyncio
async def test_recent_activity_selection_both_flows():
    """Test recent activity selection works for both flows."""
    # Test activity_desc_X callback works for both
    pass
```

**–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ integration tests:**
```bash
pytest tests/integration/test_activity_flows.py -v
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Coverage >85%

---

## ‚úÖ TODO 6.7: –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –§–∞–∑—ã 6

```bash
git add src/api/handlers/activity/activity_creation.py
git add tests/integration/test_activity_flows.py

git commit -m "refactor(handlers): merge handlers to use shared logic

- Rewrite process_category_callback() to handle both flows
- Rewrite select_recent_activity() to use shared save function
- Rewrite process_description() to use shared validation and save
- Add _create_poll_scheduling_callback() helper
- Support both poll_category_X and activity_category_X callbacks

Both manual and automatic flows now use the same handlers with
flow differentiation via trigger_source in FSM state data."
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã

---

# üéØ –§–ê–ó–ê 7: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

**–í—Ä–µ–º—è:** 4-5 —á–∞—Å–æ–≤
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–†–∏—Å–∫:** üü¢ –ù–ò–ó–ö–ò–ô

## –¶–µ–ª—å
Comprehensive testing –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π: unit, integration, manual testing.

---

## ‚úÖ TODO 7.1: –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ unit tests

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# Run all unit tests for handlers
pytest tests/unit/handlers/ -v --cov=src/api/handlers --cov-report=term --cov-report=html

# Verify coverage is >=85%
open htmlcov/index.html  # Check coverage report

# Run specific test files
pytest tests/unit/handlers/test_shared.py -v
pytest tests/unit/handlers/test_activity_creation.py -v
pytest tests/unit/handlers/test_poll_response.py -v
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ unit tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Coverage >=85%
- [ ] –ù–µ—Ç failed tests
- [ ] –ù–µ—Ç warnings

**–ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç:**
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å failures –≤ `artifacts/analysis/refactor-progress.md`
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã

---

## ‚úÖ TODO 7.2: –ó–∞–ø—É—Å—Ç–∏—Ç—å integration tests

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# Run all integration tests
pytest tests/integration/ -v

# Run specific flow tests
pytest tests/integration/test_activity_flows.py -v

# Run with detailed output
pytest tests/integration/ -v -s
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ integration tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Manual flow —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end
- [ ] Automatic poll flow —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end
- [ ] Shared handlers —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è –æ–±–æ–∏—Ö flows

---

## ‚úÖ TODO 7.3: Type checking

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# Run mypy on all modified files
mypy src/api/handlers/activity/shared.py
mypy src/api/handlers/activity/activity_creation.py
mypy src/api/handlers/poll/poll_response.py
mypy src/api/handlers/poll/poll_sender.py
mypy src/api/keyboards/time_select.py
mypy src/api/states/activity.py

# Run mypy on entire handlers directory
mypy src/api/handlers/ --no-error-summary

# Compare with baseline
diff baselines/tests/mypy_baseline.log <(mypy src/api/handlers/ 2>&1)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ù–µ—Ç –Ω–æ–≤—ã—Ö type errors
- [ ] –í—Å–µ type hints –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –ù–µ —Ö—É–∂–µ baseline

---

## ‚úÖ TODO 7.4: Linting

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# Run ruff on modified files
ruff check src/api/handlers/activity/
ruff check src/api/handlers/poll/
ruff check src/api/keyboards/
ruff check src/api/states/

# Auto-fix issues where possible
ruff check --fix src/api/handlers/

# Compare with baseline
diff baselines/tests/ruff_baseline.log <(ruff check src/api/handlers/ 2>&1)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ù–µ—Ç –Ω–æ–≤—ã—Ö linting errors
- [ ] –í—Å–µ auto-fixable issues –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- [ ] –ù–µ —Ö—É–∂–µ baseline

---

## ‚úÖ TODO 7.5: Manual testing (–ª–æ–∫–∞–ª—å–Ω—ã–π –±–æ—Ç)

**Setup:**
```bash
# Start local bot in test mode
TELEGRAM_BOT_TOKEN=test docker-compose up -d

# Check logs
docker-compose logs -f tracker_activity_bot
```

**Test scenarios:**

### Scenario 1: Manual Flow (—Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π)
1. [ ] –ù–∞–∂–∞—Ç—å "–ó–∞–ø–∏—Å–∞—Ç—å" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
2. [ ] –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥ –≤—Ä—É—á–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1 —á–∞—Å")
3. [ ] –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
4. [ ] –í–≤–µ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
5. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, —Å–ª–µ–¥—É—é—â–∏–π poll –ù–ï –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω

### Scenario 2: Manual Flow (—Å –∫–Ω–æ–ø–∫–æ–π –ê–≤—Ç–æ)
1. [ ] –ù–∞–∂–∞—Ç—å "–ó–∞–ø–∏—Å–∞—Ç—å" –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
2. [ ] –ù–∞–∂–∞—Ç—å "‚ö°Ô∏è –ê–≤—Ç–æ (–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)"
3. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –ø–µ—Ä–∏–æ–¥ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–∫–∞–∑–∞–Ω —ç–∫—Ä–∞–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π
4. [ ] –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
5. [ ] –í—ã–±—Ä–∞—Ç—å recent activity –∏–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫
6. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, —Å–ª–µ–¥—É—é—â–∏–π poll –ù–ï –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω

### Scenario 3: Automatic Poll Flow
1. [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞ (–∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—Ç—å –≤—Ä—É—á–Ω—É—é)
2. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑–∞–Ω —ç–∫—Ä–∞–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π (period step –ø—Ä–æ–ø—É—â–µ–Ω)
3. [ ] –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
4. [ ] –í–≤–µ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
5. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞, —Å–ª–µ–¥—É—é—â–∏–π poll –ó–ê–ü–õ–ê–ù–ò–†–û–í–ê–ù

### Scenario 4: Poll Cancel
1. [ ] –î–æ–∂–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞
2. [ ] –ù–∞–∂–∞—Ç—å "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
3. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: FSM –æ—á–∏—â–µ–Ω, –ø–æ–∫–∞–∑–∞–Ω–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

### Scenario 5: FSM Timeout
1. [ ] –ù–∞—á–∞—Ç—å manual flow
2. [ ] –ù–µ –æ—Ç–≤–µ—á–∞—Ç—å 5 –º–∏–Ω—É—Ç
3. [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: FSM –æ—á–∏—â–µ–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ scenarios —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ù–µ—Ç crashes
- [ ] –ù–µ—Ç unexpected behavior
- [ ] UI —Ç–µ–∫—Å—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)

---

## ‚úÖ TODO 7.6: Regression testing

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ù–ï —Å–ª–æ–º–∞–ª–æ—Å—å:**

```bash
# Test existing functionality
pytest tests/unit/handlers/test_category_handlers.py -v
pytest tests/unit/handlers/test_main_menu.py -v
pytest tests/unit/services/ -v

# Run full test suite
pytest tests/ -v --maxfail=5
```

**Manual regression tests:**
1. [ ] –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: —Å–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ
2. [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –∏–∑–º–µ–Ω–µ–Ω–∏–µ poll interval
3. [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
4. [ ] –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –ù–µ—Ç regression failures
- [ ] –í—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## ‚úÖ TODO 7.7: Performance testing

**Metrics:**

```bash
# Measure handler execution time
pytest tests/performance/test_handler_performance.py -v

# Check database query counts
pytest tests/integration/ -v --log-cli-level=DEBUG | grep "SQL"

# Memory profiling (optional)
mprof run python -m pytest tests/integration/test_activity_flows.py
mprof plot
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Handlers –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è <500ms
- [ ] –ù–µ—Ç N+1 query problems
- [ ] Memory usage —Å—Ç–∞–±–∏–ª—å–Ω—ã–π

---

## ‚úÖ TODO 7.8: –û–±–Ω–æ–≤–∏—Ç—å tracking –¥–æ–∫—É–º–µ–Ω—Ç

**–§–∞–π–ª:** `artifacts/analysis/refactor-progress.md`

**–û–±–Ω–æ–≤–∏—Ç—å:**
```markdown
## Phases Completion

- [x] Phase 1: Preparation (100%) ‚úÖ
- [x] Phase 2: FSM States (100%) ‚úÖ
- [x] Phase 3: Shared Module (100%) ‚úÖ
- [x] Phase 4: Manual Flow (100%) ‚úÖ
- [x] Phase 5: Automatic Poll (100%) ‚úÖ
- [x] Phase 6: Handler Merge (100%) ‚úÖ
- [x] Phase 7: Testing (100%) ‚úÖ
- [ ] Phase 8: Documentation (0%)

## Test Results (Post-Refactor)

### Unit Tests
- Total: X passed, Y failed
- Coverage: XX% (target: >=85%)
- New tests added: Z

### Integration Tests
- Manual flow: PASS
- Automatic poll flow: PASS
- Shared handlers: PASS
- Backward compatibility: PASS

### Type Checking
- Errors: 0 (baseline: X)
- Improvement: ‚Üì Y errors

### Linting
- Errors: 0 (baseline: X)
- Warnings: 0 (baseline: Y)

### Manual Testing
- All scenarios: PASS
- No regressions detected
- UI/UX: Correct

## Metrics Comparison

### Before Refactor
- LOC (handlers): ~730
- Duplication: 65-70%
- StateGroups: 2
- Test Coverage: XX%

### After Refactor
- LOC (handlers): ~420
- Duplication: <10%
- StateGroups: 1
- Test Coverage: XX%

### Improvements
- Code reduction: -310 LOC (-42%)
- Duplication reduction: ~60 percentage points
- Architecture: Simplified (1 StateGroup instead of 2)
- Test coverage: +X% (or maintained)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Progress –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] Metrics –∑–∞–ø–∏—Å–∞–Ω—ã
- [ ] Test results –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

# üéØ –§–ê–ó–ê 8: –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ò –î–ï–ü–õ–û–ô

**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü† –í–´–°–û–ö–ò–ô
**–†–∏—Å–∫:** üü¢ –ù–ò–ó–ö–ò–ô

## –¶–µ–ª—å
–§–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, —Å–æ–∑–¥–∞—Ç—å PR, –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.

---

## ‚úÖ TODO 8.1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å docstrings –≤–æ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:**

```bash
# Check all docstrings are present
grep -L '"""' src/api/handlers/activity/shared.py
grep -L '"""' src/api/handlers/activity/activity_creation.py
grep -L '"""' src/api/handlers/poll/poll_sender.py

# Validate docstring format
pydocstyle src/api/handlers/activity/
pydocstyle src/api/handlers/poll/
```

**–û–±–Ω–æ–≤–∏—Ç—å:**
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç docstrings
- [ ] –í—Å–µ docstrings —Å–æ–¥–µ—Ä–∂–∞—Ç Args, Returns, Examples
- [ ] –í—Å–µ docstrings –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- [ ] –í—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–Ω—è—Ç–Ω—ã–µ

---

## ‚úÖ TODO 8.2: –°–æ–∑–¥–∞—Ç—å CHANGELOG.md entry

**–§–∞–π–ª:** `CHANGELOG.md`

**–î–æ–±–∞–≤–∏—Ç—å:**

```markdown
## [Unreleased]

### Changed
- **[BREAKING]** Consolidated FSM states: removed `PollStates`, all flows now use `ActivityStates`
- **[FEATURE]** Added "Auto" button to manual activity recording for automatic period calculation
- **[REFACTOR]** Merged activity recording handlers to eliminate 65-70% code duplication
- **[IMPROVEMENT]** Automatic polls now skip period selection screen (2-step flow instead of 3)

### Added
- New shared module `src/api/handlers/activity/shared.py` with reusable logic
- `validate_description()` - input validation function
- `fetch_and_build_description_prompt()` - prompt building with suggestions
- `create_and_save_activity()` - unified activity save function with callbacks
- Comprehensive unit tests for shared module (>90% coverage)
- Integration tests for merged flows

### Removed
- `src/api/states/poll.py` - no longer needed (consolidated into `ActivityStates`)
- Duplicate handlers from `poll_response.py`

### Fixed
- Flow differentiation now handled via `trigger_source` in FSM state data
- Post-save callbacks enable flow-specific actions (e.g., scheduling next poll)

### Migration Notes
- If you have active FSM sessions with `PollStates`, they will be invalidated
- Recommend deploying during low-activity period
- All poll-related callbacks now use `ActivityStates` internally

### Metrics
- Code reduction: -310 LOC (-42%)
- Duplication reduction: ~60 percentage points
- Maintained test coverage: >=85%
- Architecture simplified: 1 StateGroup instead of 2
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] CHANGELOG –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Migration notes –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

## ‚úÖ TODO 8.3: –û–±–Ω–æ–≤–∏—Ç—å README (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

**–§–∞–π–ª:** `README.md`

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å:**
- [ ] Architecture diagrams (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] FSM state flow diagrams
- [ ] API documentation (–µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è PollStates)

**–û–±–Ω–æ–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ:**
```markdown
## Architecture

### FSM States
All activity recording (manual and automatic) uses `ActivityStates`:
- `waiting_for_period` - Period selection (manual) or skipped (automatic)
- `waiting_for_category` - Category selection (both flows)
- `waiting_for_description` - Description input (both flows)

Flows differentiate via `trigger_source` in FSM state data:
- `"manual"` - User-initiated recording
- `"automatic"` - Scheduled poll response
```

---

## ‚úÖ TODO 8.4: –°–æ–∑–¥–∞—Ç—å Pull Request

**–ö–æ–º–∞–Ω–¥—ã:**

```bash
# Push feature branch
git push origin feature/merge-activity-flows-variant-b

# Create PR using gh CLI
gh pr create \
  --title "Refactor: Merge activity recording flows (Variant B)" \
  --body "$(cat <<'EOF'
## Summary

Implements **Variant B (Optional Period)** refactoring to merge manual activity recording and automatic poll response flows, eliminating 65-70% code duplication.

## Changes

### üî¥ Breaking Changes
- Removed `PollStates` StateGroup - all flows now use `ActivityStates`
- Active FSM sessions with `PollStates` will be invalidated

### ‚ú® Features
- Added "‚ö°Ô∏è –ê–≤—Ç–æ" button to manual flow for auto period calculation
- Automatic polls now skip period selection (direct to category)
- Unified handlers for both flows with trigger differentiation

### üîß Refactoring
- Created shared module with reusable logic:
  - `validate_description()` - input validation
  - `fetch_and_build_description_prompt()` - prompt building
  - `create_and_save_activity()` - unified save with callbacks
- Merged duplicate handlers using flow differentiation via `trigger_source`
- Added post-save callbacks for flow-specific actions

### üìä Metrics
- **Code reduction:** -310 LOC (-42%)
- **Duplication:** 65-70% ‚Üí <10%
- **Architecture:** 2 StateGroups ‚Üí 1
- **Test coverage:** Maintained at >=85%
- **New tests:** +150 lines

## Testing

- ‚úÖ All unit tests pass (>85% coverage)
- ‚úÖ All integration tests pass
- ‚úÖ Manual testing completed (5 scenarios)
- ‚úÖ No regressions detected
- ‚úÖ Type checking clean
- ‚úÖ Linting clean

## Migration

**Deployment notes:**
- Deploy during low-activity period if possible
- Active poll FSM sessions will be cleared
- No database migrations required
- Backward compatible with existing data

## Files Changed

### Deleted (1)
- `src/api/states/poll.py`

### Modified (5)
- `src/api/states/activity.py` - Updated docstrings
- `src/api/handlers/activity/activity_creation.py` - Merged handlers
- `src/api/handlers/poll/poll_response.py` - Removed duplicates
- `src/api/handlers/poll/poll_sender.py` - Skip period step
- `src/api/keyboards/time_select.py` - Added Auto button

### Created (3)
- `src/api/handlers/activity/shared.py` - Shared logic module
- `tests/unit/handlers/test_shared.py` - Shared module tests
- `tests/integration/test_activity_flows.py` - E2E flow tests

## Checklist

- [x] Code follows project style guidelines
- [x] All tests pass
- [x] Documentation updated
- [x] CHANGELOG.md updated
- [x] No regressions detected
- [x] Backward compatibility maintained

## Related

- Planning doc: `artifacts/analysis/refactor-2025-11-11-(1).md`
- Progress tracking: `artifacts/analysis/refactor-progress.md`
- Pre-refactor backup: `backups/pre-refactor-2025-11-11/`

/cc @team-leads
EOF
)" \
  --label "refactoring" \
  --label "breaking-change" \
  --reviewer team-leads
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] PR —Å–æ–∑–¥–∞–Ω
- [ ] Title –∏ body –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é
- [ ] Labels –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] Reviewers –Ω–∞–∑–Ω–∞—á–µ–Ω—ã

---

## ‚úÖ TODO 8.5: Code review –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞

**–°–æ–∑–¥–∞—Ç—å summary –¥–ª—è reviewers:**

**–§–∞–π–ª:** `artifacts/analysis/code-review-guide.md`

```markdown
# Code Review Guide: Activity Flows Refactoring

## Quick Overview

**What:** Merge manual activity recording and automatic poll flows
**Why:** Eliminate 65-70% code duplication
**How:** Variant B (Optional Period) - shared handlers with flow differentiation

## Key Changes to Review

### 1. Shared Module (`src/api/handlers/activity/shared.py`)
**Review focus:** Logic correctness, error handling
- `validate_description()` - Simple validation (lines 773-806)
- `fetch_and_build_description_prompt()` - Complex fetching logic (lines 893-999)
- `create_and_save_activity()` - Critical save logic with callbacks (lines 1143-1314)

**Key question:** Is error handling comprehensive?

### 2. Manual Flow Changes (`activity_creation.py`)
**Review focus:** New Auto button, handler updates
- `get_period_keyboard_with_auto()` - New keyboard layout (keyboard/time_select.py:1372-1419)
- `start_add_activity()` - Sets `trigger_source="manual"` (lines 1457-1502)
- `auto_calculate_period()` - New handler for Auto button (lines 1518-1647)
- `process_category_callback()` - Now handles both flows (Phase 6)

**Key question:** Does trigger_source differentiation work correctly?

### 3. Automatic Poll Changes (`poll_sender.py`, `poll_response.py`)
**Review focus:** Period skip, handler removal
- `send_automatic_poll()` - Rewritten to skip period (lines 1797-1952)
- Removed duplicate handlers from `poll_response.py`
- `handle_poll_cancel()` - Now validates trigger_source (lines 2019-2067)

**Key question:** Is flow entry point correct (skips period)?

### 4. FSM States Consolidation
**Review focus:** State mapping correctness
- Removed `PollStates` completely
- All flows use `ActivityStates`
- Mapping documented in `migration/pollstates_to_activitystates_mapping.json`

**Key question:** Are all PollStates references removed?

## Testing Coverage

- **Unit tests:** `tests/unit/handlers/test_shared.py` (>90% coverage)
- **Integration tests:** `tests/integration/test_activity_flows.py`
- **Manual testing:** 5 scenarios documented in Phase 7

## Potential Issues

1. **FSM conflicts:** Active sessions will be cleared (acceptable trade-off)
2. **Callback format:** Support both `poll_category_X` and `activity_category_X`
3. **Post-save callback errors:** Should not fail main operation (handled)

## Review Checklist

- [ ] Shared functions are correct and well-tested
- [ ] Manual flow works with Auto button
- [ ] Automatic flow skips period selection correctly
- [ ] Both flows use shared handlers
- [ ] trigger_source differentiation is consistent
- [ ] Error handling is comprehensive
- [ ] Logging is adequate for debugging
- [ ] No regressions in existing functionality
- [ ] Documentation is clear
- [ ] Migration notes are accurate

## Questions for Reviewers

1. Is the post-save callback pattern acceptable?
2. Should we add telemetry for Auto button usage?
3. Should we add feature flag for gradual rollout?
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Review guide —Å–æ–∑–¥–∞–Ω
- [ ] Key changes –≤—ã–¥–µ–ª–µ–Ω—ã
- [ ] Potential issues –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## ‚úÖ TODO 8.6: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é

**Pre-deploy checklist:**

```bash
# 1. Final test run
pytest tests/ -v --maxfail=1

# 2. Build check
docker-compose build tracker_activity_bot

# 3. Smoke test in staging
ENVIRONMENT=staging docker-compose up -d
# Run manual tests in staging
docker-compose down

# 4. Database backup (if needed)
# (Not needed for this refactor - no schema changes)

# 5. Create deployment tag
git tag -a v1.5.0-variant-b -m "Release: Activity flows refactoring (Variant B)"
git push origin v1.5.0-variant-b
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] All tests pass
- [ ] Build succeeds
- [ ] Staging tests pass
- [ ] Tag created

---

## ‚úÖ TODO 8.7: Deploy to production

**Deployment steps:**

```bash
# 1. Merge PR –ø–æ—Å–ª–µ approval
gh pr merge --squash --delete-branch

# 2. Pull changes –Ω–∞ production server
ssh production-server
cd /app/activity-tracker-bot
git checkout master
git pull origin master

# 3. Rebuild containers
docker-compose build
docker-compose down
docker-compose up -d

# 4. Monitor logs
docker-compose logs -f --tail=100 tracker_activity_bot

# 5. Verify health
curl http://localhost:8000/health
# Check bot responds to /start command

# 6. Monitor for 30 minutes
watch -n 10 'docker-compose logs --tail=20 tracker_activity_bot'
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Deployment —É—Å–ø–µ—à–Ω—ã–π
- [ ] –ù–µ—Ç errors –≤ –ª–æ–≥–∞—Ö
- [ ] Bot –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
- [ ] Manual smoke test pass
- [ ] Automatic poll works

---

## ‚úÖ TODO 8.8: Post-deploy monitoring

**Monitor –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤:**

```bash
# Check error rates
grep ERROR logs/app.log | wc -l

# Check FSM state distribution
# (Should see more ActivityStates, zero PollStates)

# Check performance
# (Response times should be similar or better)

# User feedback
# (Monitor support channels)
```

**Metrics to track:**
- [ ] Error rate –Ω–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è
- [ ] Response time —Å—Ç–∞–±–∏–ª—å–Ω—ã–π
- [ ] FSM states –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ
- [ ] –ù–µ—Ç user complaints
- [ ] Auto button usage (–µ—Å–ª–∏ –µ—Å—Ç—å telemetry)

**–ï—Å–ª–∏ –µ—Å—Ç—å issues:**
1. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `artifacts/analysis/post-deploy-issues.md`
2. –†–µ—à–∏—Ç—å, –Ω—É–∂–µ–Ω –ª–∏ hotfix –∏–ª–∏ rollback
3. –°–æ–∑–¥–∞—Ç—å hotfix PR –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

## ‚úÖ TODO 8.9: Final documentation update

**–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:**

**–§–∞–π–ª:** `artifacts/analysis/refactor-progress.md`

```markdown
## Status: ‚úÖ COMPLETED

**Completed:** 2025-11-XX
**Deployed:** 2025-11-XX
**Overall Success:** YES

## Final Metrics

### Code Quality
- LOC reduction: -310 lines (-42%)
- Duplication: 65-70% ‚Üí <10%
- StateGroups: 2 ‚Üí 1
- Test coverage: XX% ‚Üí XX%

### Test Results
- Unit tests: XXX passed, 0 failed
- Integration tests: XX passed, 0 failed
- Type checking: 0 errors
- Linting: 0 errors

### Deployment
- Deployment time: XX minutes
- Downtime: 0 seconds
- Rollback needed: NO
- Issues found: 0 critical, X minor

### Post-Deploy (24h)
- Error rate change: +0%
- Performance change: +X% (improvement)
- User complaints: 0
- Auto button usage: XX uses

## Lessons Learned

### What Went Well
1. Comprehensive planning prevented surprises
2. Incremental commits made review easier
3. Extensive testing caught all issues before deploy
4. Shared module design is clean and reusable

### What Could Be Improved
1. [List any issues or improvements]

### Recommendations for Future
1. Consider feature flags for large refactors
2. Add telemetry earlier in process
3. [Other recommendations]

## Acknowledgments

- Planning: Claude Code
- Implementation: Claude Code + Human review
- Testing: Automated + Manual
- Review: [Team members]
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Final metrics –∑–∞–ø–∏—Å–∞–Ω—ã
- [ ] Lessons learned –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Recommendations –¥–ª—è future

---

## ‚úÖ TODO 8.10: Cleanup

**Clean up temporary files and branches:**

```bash
# Delete feature branch (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
git branch -d feature/merge-activity-flows-variant-b
git push origin --delete feature/merge-activity-flows-variant-b

# Archive backup files
tar -czf backups/pre-refactor-2025-11-11-ARCHIVED.tar.gz backups/pre-refactor-2025-11-11/
rm -rf backups/pre-refactor-2025-11-11/

# Move planning docs to archive
mkdir -p artifacts/archive/2025-11/
mv artifacts/analysis/refactor-2025-11-11-(1).md artifacts/archive/2025-11/
mv artifacts/analysis/refactor-progress.md artifacts/archive/2025-11/
mv artifacts/analysis/code-review-guide.md artifacts/archive/2025-11/

# Commit cleanup
git add .
git commit -m "chore: archive refactoring documentation"
git push origin master
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Temporary files cleaned
- [ ] Backups archived
- [ ] Documentation archived
- [ ] Repository clean

---

# üéâ –†–ï–§–ê–ö–¢–û–†–ò–ù–ì –ó–ê–í–ï–†–®–ï–ù!

**Congratulations!** –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ **Variant B (Optional Period)**.

## –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

‚úÖ **Code Quality:**
- –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ ~42% (-310 LOC)
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å 65-70% –¥–æ <10%
- –£–ø—Ä–æ—â–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (1 StateGroup –≤–º–µ—Å—Ç–æ 2)

‚úÖ **Functionality:**
- Manual flow: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ê–≤—Ç–æ"
- Automatic poll: –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —ç–∫—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥–∞
- Shared handlers: –µ–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±–æ–∏—Ö flows

‚úÖ **Quality:**
- Test coverage >=85%
- 0 type errors
- 0 linting errors
- –í—Å–µ tests pass

‚úÖ **Documentation:**
- Comprehensive planning –¥–æ–∫—É–º–µ–Ω—Ç
- Updated CHANGELOG.md
- Code review guide
- Post-deploy metrics

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. **Monitor production** –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
2. **Gather user feedback** –æ–± Auto button
3. **Consider –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ telemetry** –¥–ª—è usage metrics
4. **Plan next improvements** –Ω–∞ –æ—Å–Ω–æ–≤–µ feedback

---

**Detailed Plan Document Ends Here**

üìÑ **Total:** 8 phases, ~70 TODOs, estimated 23-30 hours
üéØ **Status:** Ready for Implementation
üìÖ **Created:** 2025-11-11
‚ú® **Version:** 1.0 COMPLETE
