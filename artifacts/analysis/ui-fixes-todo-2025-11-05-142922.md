# TODO: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –±–æ—Ç–∞
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-05 14:29:22
**–û—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ê—É–¥–∏—Ç UI —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ—Ç 2025-11-05
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–±–æ—Ç–µ

---

## üìã –°–û–î–ï–†–ñ–ê–ù–ò–ï

1. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã) - 3 –∑–∞–¥–∞—á–∏
2. [–í–∞–∂–Ω—ã–µ –Ω–µ–¥–æ—á–µ—Ç—ã](#–≤–∞–∂–Ω—ã–µ-–Ω–µ–¥–æ—á–µ—Ç—ã) - 5 –∑–∞–¥–∞—á
3. [–£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞](#—É–ª—É—á—à–µ–Ω–∏—è-–∫–∞—á–µ—Å—Ç–≤–∞) - 6 –∑–∞–¥–∞—á
4. [–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏](#–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π-—Å–ø–∏—Å–æ–∫)

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### ‚ùå –ó–ê–î–ê–ß–ê 1: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –æ–ø—Ä–æ—Å–∞ "–Ø –∑–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ"

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/poll.py`
- `services/tracker_activity_bot/src/api/keyboards/poll.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–ø—Ä–æ—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–Ω–æ–ø–∫–∞ "–Ø –∑–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ", –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –∑–∞–ø–∏—Å–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è `PollStates.waiting_for_poll_category` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- poll.py:299-309 (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –Ω–µ–ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
- poll.py:6 (–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 1.1: –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
```python
# –§–∞–π–ª: src/api/keyboards/poll.py
# –§—É–Ω–∫—Ü–∏—è: get_poll_response_keyboard()

# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 15:
[InlineKeyboardButton(text="‚úèÔ∏è –ó–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ", callback_data="poll_activity")],
```

#### –®–∞–≥ 1.2: –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
```python
# –§–∞–π–ª: src/api/handlers/poll.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ handle_poll_remind (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 260)

@router.callback_query(F.data == "poll_activity")
async def handle_poll_activity_start(callback: types.CallbackQuery, state: FSMContext):
    """Handle 'I was doing something' poll response.

    Start activity recording from poll. User will select category,
    and activity will be created with automatic time calculation.
    """
    user_service = UserService(api_client)
    category_service = CategoryService(api_client)
    telegram_id = callback.from_user.id

    try:
        # Get user
        user = await user_service.get_by_telegram_id(telegram_id)
        if not user:
            await callback.message.answer("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            await callback.answer()
            return

        # Get categories
        categories = await category_service.get_user_categories(user["id"])

        if not categories:
            await callback.message.answer(
                "‚ö†Ô∏è –£ —Ç–µ–±—è –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
                reply_markup=get_main_menu_keyboard()
            )
            await callback.answer()
            return

        # Store user_id in state for later use
        await state.update_data(user_id=user["id"])
        await state.set_state(PollStates.waiting_for_poll_category)

        text = (
            "‚úèÔ∏è –ß–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è?\n\n"
            "–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:"
        )

        await callback.message.answer(
            text,
            reply_markup=get_poll_category_keyboard(categories)
        )
        await callback.answer()

    except Exception as e:
        logger.error(f"Error in handle_poll_activity_start: {e}")
        await callback.message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
        await callback.answer()
```

#### –®–∞–≥ 1.3: –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
```python
# –§–∞–π–ª: src/api/handlers/poll.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

@router.callback_query(PollStates.waiting_for_poll_category, F.data.startswith("poll_category_"))
async def handle_poll_category_select(callback: types.CallbackQuery, state: FSMContext):
    """Handle category selection in poll activity recording.

    Creates activity with automatic time calculation based on poll interval.
    """
    category_id = int(callback.data.split("_")[-1])

    user_service = UserService(api_client)
    settings_service = UserSettingsService(api_client)
    activity_service = ActivityService(api_client)
    telegram_id = callback.from_user.id

    try:
        # Get user and settings
        user = await user_service.get_by_telegram_id(telegram_id)
        settings = await settings_service.get_settings(user["id"])

        # Calculate time range based on poll interval
        from datetime import datetime, timedelta, timezone
        end_time = datetime.now(timezone.utc)

        # Use appropriate interval based on day of week
        is_weekend = end_time.weekday() >= 5  # Saturday=5, Sunday=6
        interval_minutes = (
            settings["poll_interval_weekend"]
            if is_weekend
            else settings["poll_interval_weekday"]
        )

        start_time = end_time - timedelta(minutes=interval_minutes)

        # Create activity with generic description
        await activity_service.create_activity(
            user_id=user["id"],
            category_id=category_id,
            description="–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
            tags=[],
            start_time=start_time,
            end_time=end_time
        )

        # Schedule next poll
        user_timezone = user.get("timezone", "Europe/Moscow")
        await scheduler_service.schedule_poll(
            user_id=telegram_id,
            settings=settings,
            user_timezone=user_timezone,
            send_poll_callback=lambda uid: send_automatic_poll(callback.bot, uid)
        )

        # Format duration
        duration_minutes = interval_minutes
        hours = duration_minutes // 60
        minutes = duration_minutes % 60
        if hours > 0 and minutes > 0:
            duration_str = f"{hours}—á {minutes}–º"
        elif hours > 0:
            duration_str = f"{hours}—á"
        else:
            duration_str = f"{minutes}–º"

        await callback.message.answer(
            f"‚úÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!\n\n"
            f"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_str}\n\n"
            f"–°–ª–µ–¥—É—é—â–∏–π –æ–ø—Ä–æ—Å –ø—Ä–∏–¥—ë—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()
        await callback.answer()

    except Exception as e:
        logger.error(f"Error in handle_poll_category_select: {e}")
        await callback.message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.")
        await state.clear()
        await callback.answer()


@router.callback_query(PollStates.waiting_for_poll_category, F.data == "poll_cancel")
async def handle_poll_cancel(callback: types.CallbackQuery, state: FSMContext):
    """Handle cancellation of poll activity recording."""
    await state.clear()
    await callback.message.answer(
        "‚ùå –ó–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=get_main_menu_keyboard()
    )
    await callback.answer()
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í –æ–ø—Ä–æ—Å–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "‚úèÔ∏è –ó–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é = –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞
- FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –î–æ–∂–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞
2. –ù–∞–∂–∞—Ç—å "‚úèÔ∏è –ó–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ"
3. –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω —Å–ª–µ–¥—É—é—â–∏–π –æ–ø—Ä–æ—Å

---

### ‚ùå –ó–ê–î–ê–ß–ê 2: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/settings.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–Ω–æ–ø–∫–∏ "‚úèÔ∏è –£–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –≤—Ä–µ–º—è" –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –¥–ª—è:
- –ò–Ω—Ç–µ—Ä–≤–∞–ª–∞ –±—É–¥–Ω–∏—Ö –¥–Ω–µ–π
- –ò–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö
- –ó–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã, –Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- settings.py:41 (callback "weekday_custom")
- settings.py:62 (callback "weekend_custom")
- settings.py:135 (callback "reminder_delay_custom")
- settings.py:558-559 (–ø—É—Å—Ç–æ–π return)

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 2.1: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –¥–ª—è –±—É–¥–Ω–∏—Ö –¥–Ω–µ–π
```python
# –§–∞–π–ª: src/api/handlers/settings.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ set_weekday_interval (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 220)

@router.callback_query(F.data == "weekday_custom")
async def show_weekday_custom_input(callback: types.CallbackQuery, state: FSMContext):
    """Show custom weekday interval input prompt."""
    text = (
        "üìÖ –£–∫–∞–∂–∏ —Å–≤–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±—É–¥–Ω–∏—Ö –¥–Ω–µ–π\n\n"
        "–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç (–æ—Ç 30 –¥–æ 480).\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ 90 ‚Äî –∫–∞–∂–¥—ã–µ 1.5 —á–∞—Å–∞\n"
        "‚Ä¢ 150 ‚Äî –∫–∞–∂–¥—ã–µ 2.5 —á–∞—Å–∞\n\n"
        "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã"
    )

    await callback.message.answer(text)
    await state.set_state(SettingsStates.waiting_for_weekday_interval_custom)
    await callback.answer()


@router.message(SettingsStates.waiting_for_weekday_interval_custom)
async def process_weekday_custom_input(message: types.Message, state: FSMContext):
    """Process custom weekday interval input."""
    try:
        interval = int(message.text.strip())

        # Validation
        if interval < 30 or interval > 480:
            await message.answer(
                "‚ö†Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 30 –¥–æ 480 –º–∏–Ω—É—Ç (0.5-8 —á–∞—Å–æ–≤).\n"
                "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
            )
            return

        user_service = UserService(api_client)
        settings_service = UserSettingsService(api_client)
        telegram_id = message.from_user.id

        user = await user_service.get_by_telegram_id(telegram_id)
        settings = await settings_service.get_settings(user["id"])

        await settings_service.update_settings(settings["id"], poll_interval_weekday=interval)

        # Fetch updated settings and reschedule poll
        updated_settings = await settings_service.get_settings(user["id"])
        from src.api.handlers.poll import send_automatic_poll
        await scheduler_service.schedule_poll(
            user_id=telegram_id,
            settings=updated_settings,
            user_timezone=user.get("timezone", "Europe/Moscow"),
            send_poll_callback=lambda uid: send_automatic_poll(message.bot, uid)
        )
        logger.info(f"Rescheduled poll for user {telegram_id} with custom weekday interval {interval}")

        hours = interval // 60
        minutes = interval % 60
        if hours > 0 and minutes > 0:
            interval_str = f"{hours}—á {minutes}–º"
        elif hours > 0:
            interval_str = f"{hours}—á"
        else:
            interval_str = f"{minutes}–º"

        text = (
            f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –±—É–¥–Ω–∏—Ö –¥–Ω–µ–π –æ–±–Ω–æ–≤–ª—ë–Ω!\n\n"
            f"–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ {interval_str} –≤ –±—É–¥–Ω–∏–µ –¥–Ω–∏."
        )

        await message.answer(text, reply_markup=get_confirmation_keyboard())
        await state.clear()

    except ValueError:
        await message.answer(
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –í–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 90):"
        )
```

#### –®–∞–≥ 2.2: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö
```python
# –§–∞–π–ª: src/api/handlers/settings.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ set_weekend_interval (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 278)

@router.callback_query(F.data == "weekend_custom")
async def show_weekend_custom_input(callback: types.CallbackQuery, state: FSMContext):
    """Show custom weekend interval input prompt."""
    text = (
        "üéâ –£–∫–∞–∂–∏ —Å–≤–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö\n\n"
        "–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç (–æ—Ç 30 –¥–æ 600).\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã:\n"
        "‚Ä¢ 120 ‚Äî –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞\n"
        "‚Ä¢ 210 ‚Äî –∫–∞–∂–¥—ã–µ 3.5 —á–∞—Å–∞\n\n"
        "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã"
    )

    await callback.message.answer(text)
    await state.set_state(SettingsStates.waiting_for_weekend_interval_custom)
    await callback.answer()


@router.message(SettingsStates.waiting_for_weekend_interval_custom)
async def process_weekend_custom_input(message: types.Message, state: FSMContext):
    """Process custom weekend interval input."""
    try:
        interval = int(message.text.strip())

        # Validation
        if interval < 30 or interval > 600:
            await message.answer(
                "‚ö†Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 30 –¥–æ 600 –º–∏–Ω—É—Ç (0.5-10 —á–∞—Å–æ–≤).\n"
                "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
            )
            return

        user_service = UserService(api_client)
        settings_service = UserSettingsService(api_client)
        telegram_id = message.from_user.id

        user = await user_service.get_by_telegram_id(telegram_id)
        settings = await settings_service.get_settings(user["id"])

        await settings_service.update_settings(settings["id"], poll_interval_weekend=interval)

        # Fetch updated settings and reschedule poll
        updated_settings = await settings_service.get_settings(user["id"])
        from src.api.handlers.poll import send_automatic_poll
        await scheduler_service.schedule_poll(
            user_id=telegram_id,
            settings=updated_settings,
            user_timezone=user.get("timezone", "Europe/Moscow"),
            send_poll_callback=lambda uid: send_automatic_poll(message.bot, uid)
        )
        logger.info(f"Rescheduled poll for user {telegram_id} with custom weekend interval {interval}")

        hours = interval // 60
        minutes = interval % 60
        if hours > 0 and minutes > 0:
            interval_str = f"{hours}—á {minutes}–º"
        elif hours > 0:
            interval_str = f"{hours}—á"
        else:
            interval_str = f"{minutes}–º"

        text = (
            f"‚úÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –æ–±–Ω–æ–≤–ª—ë–Ω!\n\n"
            f"–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –∫–∞–∂–¥—ã–µ {interval_str} –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏."
        )

        await message.answer(text, reply_markup=get_confirmation_keyboard())
        await state.clear()

    except ValueError:
        await message.answer(
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –í–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 120):"
        )
```

#### –®–∞–≥ 2.3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
```python
# –§–∞–π–ª: src/api/handlers/settings.py
# –ó–ê–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫–∏ 553-559 –Ω–∞:

@router.callback_query(F.data.startswith("reminder_delay_"))
async def set_reminder_delay(callback: types.CallbackQuery, state: FSMContext):
    """Set reminder delay."""
    # Extract delay from callback data (e.g., "reminder_delay_30" -> 30)
    parts = callback.data.split("_")

    if parts[-1] == "custom":
        # Handle custom input - show input prompt
        text = (
            "‚è± –£–∫–∞–∂–∏ —Å–≤–æ—é –∑–∞–¥–µ—Ä–∂–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n\n"
            "–í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç (–æ—Ç 5 –¥–æ 120).\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã:\n"
            "‚Ä¢ 10 ‚Äî –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç\n"
            "‚Ä¢ 45 ‚Äî –Ω–∞–ø–æ–º–Ω–∏—Ç—å —á–µ—Ä–µ–∑ 45 –º–∏–Ω—É—Ç\n\n"
            "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã"
        )

        await callback.message.answer(text)
        await state.set_state(SettingsStates.waiting_for_reminder_delay_custom)
        await callback.answer()
        return

    delay = int(parts[-1])

    user_service = UserService(api_client)
    settings_service = UserSettingsService(api_client)
    telegram_id = callback.from_user.id

    user = await user_service.get_by_telegram_id(telegram_id)
    settings = await settings_service.get_settings(user["id"])

    await settings_service.update_settings(settings["id"], reminder_delay_minutes=delay)

    text = f"‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —á–µ—Ä–µ–∑ {delay} –º–∏–Ω—É—Ç."

    await callback.message.answer(text, reply_markup=get_confirmation_keyboard())
    await callback.answer()


@router.message(SettingsStates.waiting_for_reminder_delay_custom)
async def process_reminder_delay_custom(message: types.Message, state: FSMContext):
    """Process custom reminder delay input."""
    try:
        delay = int(message.text.strip())

        # Validation
        if delay < 5 or delay > 120:
            await message.answer(
                "‚ö†Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 5 –¥–æ 120 –º–∏–Ω—É—Ç.\n"
                "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:"
            )
            return

        user_service = UserService(api_client)
        settings_service = UserSettingsService(api_client)
        telegram_id = message.from_user.id

        user = await user_service.get_by_telegram_id(telegram_id)
        settings = await settings_service.get_settings(user["id"])

        await settings_service.update_settings(settings["id"], reminder_delay_minutes=delay)

        text = f"‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!\n\n–¢–µ–ø–µ—Ä—å –±–æ—Ç –±—É–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —á–µ—Ä–µ–∑ {delay} –º–∏–Ω—É—Ç."

        await message.answer(text, reply_markup=get_confirmation_keyboard())
        await state.clear()

    except ValueError:
        await message.answer(
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –í–≤–µ–¥–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 45):"
        )
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í—Å–µ –∫–Ω–æ–ø–∫–∏ "‚úèÔ∏è –£–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –≤—Ä–µ–º—è" —Ä–∞–±–æ—Ç–∞—é—Ç
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –ë–î
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ–ø—Ä–æ—Å–æ–≤

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ó–∞–π—Ç–∏ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã ‚Üí –ë—É–¥–Ω–∏–µ –¥–Ω–∏
2. –ù–∞–∂–∞—Ç—å "‚úèÔ∏è –£–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –≤—Ä–µ–º—è"
3. –í–≤–µ—Å—Ç–∏ 90
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–∏–ª—Å—è
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

---

### ‚ùå –ó–ê–î–ê–ß–ê 3: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /cancel –¥–ª—è FSM

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/settings.py`
- `services/tracker_activity_bot/src/api/handlers/activity.py`
- `services/tracker_activity_bot/src/api/handlers/categories.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í UI –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—Å—Ç "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã", –Ω–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–ª—è –≤—Å–µ—Ö FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- settings.py:419, 458 (—Ç–µ–∫—Å—Ç —Å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º /cancel)
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–æ –≤—Å–µ—Ö handler —Ñ–∞–π–ª–∞—Ö

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 3.1: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /cancel –≤ settings.py
```python
# –§–∞–π–ª: src/api/handlers/settings.py
# –î–û–ë–ê–í–ò–¢–¨ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞, –ø–µ—Ä–µ–¥ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π return_to_main_menu

from aiogram.filters import Command

@router.message(Command("cancel"))
async def cancel_settings_fsm(message: types.Message, state: FSMContext):
    """Cancel any active FSM state in settings.

    Handles /cancel command to exit from:
    - Custom interval input
    - Custom quiet hours time input
    - Custom reminder delay input
    """
    current_state = await state.get_state()

    if current_state is None:
        await message.answer(
            "–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å. –¢—ã —Å–µ–π—á–∞—Å –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.",
            reply_markup=get_main_menu_keyboard()
        )
        return

    await state.clear()
    await message.answer(
        "‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=get_main_menu_keyboard()
    )
```

#### –®–∞–≥ 3.2: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /cancel –≤ activity.py
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ cancel_action (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 444)

from aiogram.filters import Command

@router.message(Command("cancel"))
async def cancel_activity_fsm(message: types.Message, state: FSMContext):
    """Cancel activity recording process.

    Handles /cancel command to exit from activity recording FSM.
    """
    current_state = await state.get_state()

    if current_state is None or not current_state.startswith("ActivityStates"):
        await message.answer(
            "–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å. –¢—ã —Å–µ–π—á–∞—Å –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—à—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.",
            reply_markup=get_main_menu_keyboard()
        )
        return

    await state.clear()
    await message.answer(
        "‚ùå –ó–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=get_main_menu_keyboard()
    )
```

#### –®–∞–≥ 3.3: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /cancel –≤ categories.py
```python
# –§–∞–π–ª: src/api/handlers/categories.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ show_main_menu (–≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞)

from aiogram.filters import Command

@router.message(Command("cancel"))
async def cancel_category_fsm(message: types.Message, state: FSMContext):
    """Cancel category creation process.

    Handles /cancel command to exit from category management FSM.
    """
    current_state = await state.get_state()

    if current_state is None or not current_state.startswith("CategoryStates"):
        await message.answer(
            "–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å. –¢—ã —Å–µ–π—á–∞—Å –Ω–µ —Å–æ–∑–¥–∞—ë—à—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
            reply_markup=get_main_menu_keyboard()
        )
        return

    await state.clear()
    await message.answer(
        "‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
        reply_markup=get_main_menu_keyboard()
    )
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–æ–º–∞–Ω–¥–∞ /cancel —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–æ –≤—Å–µ—Ö FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ FSM –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
- –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
2. –ù–∞ –ª—é–±–æ–º —à–∞–≥–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /cancel
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ FSM –æ—á–∏—â–µ–Ω –∏ –ø–æ–∫–∞–∑–∞–Ω–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## üü° –í–ê–ñ–ù–´–ï –ù–ï–î–û–ß–ï–¢–´

### ‚ö†Ô∏è –ó–ê–î–ê–ß–ê 4: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä —Å –ø—É—Å—Ç—ã–º–∏ —Å–ø–∏—Å–∫–∞–º–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–ê–ñ–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/keyboards/settings.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ `[] if condition` –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏ –≤ inline_keyboard, —á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- settings.py:77 (get_quiet_hours_main_keyboard)
- settings.py:116 (get_reminders_keyboard)

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 4.1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å get_quiet_hours_main_keyboard
```python
# –§–∞–π–ª: src/api/keyboards/settings.py
# –ó–ê–ú–ï–ù–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é get_quiet_hours_main_keyboard (—Å—Ç—Ä–æ–∫–∏ 68-80):

def get_quiet_hours_main_keyboard(enabled: bool = True) -> InlineKeyboardMarkup:
    """Keyboard for quiet hours configuration."""
    toggle_button = InlineKeyboardButton(
        text="‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å —Ç–∏—Ö–∏–µ —á–∞—Å—ã" if enabled else "‚úÖ –í–∫–ª—é—á–∏—Ç—å —Ç–∏—Ö–∏–µ —á–∞—Å—ã",
        callback_data="quiet_toggle"
    )

    buttons = [
        [toggle_button],
    ]

    # Add time change button only if enabled
    if enabled:
        buttons.append([InlineKeyboardButton(text="‚è∞ –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è", callback_data="quiet_time")])

    # Add back button
    buttons.append([InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data="settings")])

    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)
    return keyboard
```

#### –®–∞–≥ 4.2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å get_reminders_keyboard
```python
# –§–∞–π–ª: src/api/keyboards/settings.py
# –ó–ê–ú–ï–ù–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é get_reminders_keyboard (—Å—Ç—Ä–æ–∫–∏ 107-119):

def get_reminders_keyboard(enabled: bool = True) -> InlineKeyboardMarkup:
    """Keyboard for reminder configuration."""
    toggle_button = InlineKeyboardButton(
        text="‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å" if enabled else "‚úÖ –í–∫–ª—é—á–∏—Ç—å",
        callback_data="reminder_toggle"
    )

    buttons = [
        [toggle_button],
    ]

    # Add delay button only if enabled
    if enabled:
        buttons.append([InlineKeyboardButton(text="‚è± –ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É", callback_data="reminder_delay")])

    # Add back button
    buttons.append([InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º", callback_data="settings")])

    keyboard = InlineKeyboardMarkup(inline_keyboard=buttons)
    return keyboard
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ù–µ—Ç –ø—É—Å—Ç—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
- –ö–Ω–æ–ø–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ó–∞–π—Ç–∏ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –¢–∏—Ö–∏–µ —á–∞—Å—ã
2. –û—Ç–∫–ª—é—á–∏—Ç—å —Ç–∏—Ö–∏–µ —á–∞—Å—ã
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–Ω–æ–ø–∫–∞ "–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è" –∏—Å—á–µ–∑–ª–∞
4. –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ - –∫–Ω–æ–ø–∫–∞ –ø–æ—è–≤–∏–ª–∞—Å—å
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π

---

### ‚ö†Ô∏è –ó–ê–î–ê–ß–ê 5: –î–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_poll_time –ø–æ—Å–ª–µ –æ–ø—Ä–æ—Å–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–ê–ñ–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/poll.py`
- `services/data_postgres_api/routers/users.py` (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è endpoint)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–æ–ª–µ `last_poll_time` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–Ω–∞, –Ω–æ –Ω–∏–≥–¥–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (8 —á–∞—Å–æ–≤).

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- poll.py:163-168 (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ last_poll_time)
- poll.py:27-79 (–æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø—Ä–æ—Å–∞ –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏)

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 5.1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è –≤ API
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ last_poll_time –≤ –º–æ–¥–µ–ª–∏ User
# –§–∞–π–ª: services/data_postgres_api/models/user.py
```

#### –®–∞–≥ 5.2: –ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç - –¥–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```python
# –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ data_postgres_api
# –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ last_poll_time: Optional[datetime] = None
```

#### –®–∞–≥ 5.3: –û–±–Ω–æ–≤–ª—è—Ç—å last_poll_time –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–ø—Ä–æ—Å–∞
```python
# –§–∞–π–ª: src/api/handlers/poll.py
# –ò–ó–ú–ï–ù–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é send_automatic_poll (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 75)

# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ await bot.send_message(...):

        # Update last poll time
        try:
            # Note: This requires API endpoint PATCH /api/v1/users/{id}
            # with last_poll_time field support
            import httpx
            async with httpx.AsyncClient() as client:
                await client.patch(
                    f"{api_client.base_url}/api/v1/users/{user['id']}",
                    json={"last_poll_time": datetime.now(timezone.utc).isoformat()}
                )
            logger.info(f"Updated last_poll_time for user {user_id}")
        except Exception as e:
            logger.warning(f"Could not update last_poll_time: {e}")

        logger.info(f"Sent automatic poll to user {user_id}")
```

#### –®–∞–≥ 5.4: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ scheduler
```python
# –ï—Å–ª–∏ API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç last_poll_time, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ scheduler:
# –ó–ê–ú–ï–ù–ò–¢–¨ –ª–æ–≥–∏–∫—É –≤ handle_poll_sleep (—Å—Ç—Ä–æ–∫–∏ 163-168):

        # Calculate sleep duration based on last poll time
        # Get last poll time from scheduler history
        if telegram_id in scheduler_service.jobs:
            job_id = scheduler_service.jobs[telegram_id]
            job = scheduler_service.scheduler.get_job(job_id)

            # Get settings to know interval
            is_weekend = datetime.now(timezone.utc).weekday() >= 5
            interval_minutes = (
                settings["poll_interval_weekend"]
                if is_weekend
                else settings["poll_interval_weekday"]
            )

            start_time = datetime.now(timezone.utc) - timedelta(minutes=interval_minutes)
        else:
            # Fallback to default 8 hours
            start_time = datetime.now(timezone.utc) - timedelta(hours=8)
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- last_poll_time –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ—á–Ω–æ
- –ù–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö 8 —á–∞—Å–æ–≤

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –î–æ–∂–¥–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–æ—Å–∞
2. –ù–∞–∂–∞—Ç—å "üò¥ –°–ø–∞–ª"
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å = –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞)
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è last_poll_time

---

### ‚ö†Ô∏è –ó–ê–î–ê–ß–ê 6: –î–æ–±–∞–≤–∏—Ç—å keyboard –ø–æ—Å–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–ê–ñ–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/activity.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è (process_end_time) —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –±–µ–∑ reply_markup, —Ö–æ—Ç—è –ø–æ—Å–ª–µ callback-–æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- activity.py:245 (–Ω–µ—Ç reply_markup)
- activity.py:188 (–µ—Å—Ç—å reply_markup –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 6.1: –î–æ–±–∞–≤–∏—Ç—å reply_markup –≤ process_end_time
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –ó–ê–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫—É 245:

# –ë–´–õ–û:
        await message.answer(text)

# –°–¢–ê–õ–û:
        await message.answer(text, reply_markup=get_main_menu_keyboard())
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
- –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å callback-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
2. –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∫–Ω–æ–ø–∫–æ–π
3. –í–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä "30–º")
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

---

### ‚ö†Ô∏è –ó–ê–î–ê–ß–ê 7: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ FSM –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–ø—Ä–æ—Å–∞

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–ê–ñ–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/poll.py`
- `services/tracker_activity_bot/src/application/services/scheduler_service.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–æ–ø—Ä–æ—Å - –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—É—Ç–∞–Ω–∏—Ü–∞ –≤ UI. –ï—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø—Ä–æ–≤–µ—Ä–∫–µ, –Ω–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ—Ç.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- poll.py:52-60 (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –±–µ–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 7.1: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–ø—Ä–æ—Å–æ–º
```python
# –§–∞–π–ª: src/api/handlers/poll.py
# –ó–ê–ú–ï–ù–ò–¢–¨ –±–ª–æ–∫ try –≤ send_automatic_poll (—Å—Ç—Ä–æ–∫–∏ 53-60):

        # Check if user is in active FSM state (conflict resolution)
        from aiogram.fsm.context import FSMContext
        from src.api.states.activity import ActivityStates
        from src.api.states.category import CategoryStates
        from src.api.states.settings import SettingsStates

        try:
            # Get bot instance to access storage
            from src.main import dp
            storage = dp.storage

            # Get current FSM state
            from aiogram.fsm.context import StorageKey
            key = StorageKey(
                bot_id=bot.id,
                chat_id=user_id,
                user_id=user_id
            )

            state_data = await storage.get_state(key)

            if state_data:
                # User is in active dialog - postpone poll
                logger.info(f"User {user_id} is in FSM state {state_data}, postponing poll by 10 minutes")

                # Reschedule poll in 10 minutes
                from datetime import datetime, timedelta, timezone
                from apscheduler.triggers.date import DateTrigger
                next_poll = datetime.now(timezone.utc) + timedelta(minutes=10)

                job_id = f"poll_{user_id}"
                if job_id in scheduler_service.jobs:
                    scheduler_service.scheduler.reschedule_job(
                        job_id,
                        trigger=DateTrigger(run_date=next_poll)
                    )
                    logger.info(f"Rescheduled poll for user {user_id} to {next_poll}")

                return  # Skip this poll

        except Exception as e:
            logger.debug(f"Could not check FSM state: {e}")
            # Continue with poll if check failed
```

#### –®–∞–≥ 7.2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ –≤ state data
```python
# –ë–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –¥–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ "busy" –≤ state data:

# –í –Ω–∞—á–∞–ª–µ –ª—é–±–æ–≥–æ FSM –ø—Ä–æ—Ü–µ—Å—Å–∞:
await state.update_data(user_busy=True)

# –í –∫–æ–Ω—Ü–µ FSM –ø—Ä–æ—Ü–µ—Å—Å–∞:
await state.update_data(user_busy=False)

# –í send_automatic_poll –ø—Ä–æ–≤–µ—Ä—è—Ç—å:
state_data = await state.get_data()
if state_data.get("user_busy"):
    # Postpone poll
    ...
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –¥–∏–∞–ª–æ–≥–µ - –æ–ø—Ä–æ—Å –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –Ω–∞ 10 –º–∏–Ω—É—Ç
- –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ FSM –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è –æ–ø—Ä–æ—Å–∞

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
2. –î–æ–∂–¥–∞—Ç—å—Å—è –≤—Ä–µ–º–µ–Ω–∏ –∞–≤—Ç–æ–æ–ø—Ä–æ—Å–∞ (–∏–ª–∏ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∞)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–ø—Ä–æ—Å –Ω–µ –ø—Ä–∏—à—ë–ª
4. –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç –æ–ø—Ä–æ—Å –ø—Ä–∏–¥—ë—Ç

---

### ‚ö†Ô∏è –ó–ê–î–ê–ß–ê 8: –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ inline –∫–Ω–æ–ø–∫–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–ê–ñ–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/activity.py`
- `services/tracker_activity_bot/src/api/keyboards/poll.py` (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ä–µ—à–µ–Ω–∏–µ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü—Ä–∏ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–∫—Å—Ç–æ–º. –≠—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ –∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º UX Telegram –±–æ—Ç–æ–≤. –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å inline –∫–Ω–æ–ø–∫–∏.

**–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ:**
- activity.py:297-312 (—Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º "For PoC")
- activity.py:323-400 (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ process_category –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞)

**–°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:**
–í –∫–æ–¥–µ —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `get_poll_category_keyboard()` –≤ `src/api/keyboards/poll.py:21-46`, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞—ë—Ç inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 8.1: –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤ activity.py
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –î–û–ë–ê–í–ò–¢–¨ –≤ –∏–º–ø–æ—Ä—Ç—ã (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 11):

from src.api.keyboards.poll import get_poll_category_keyboard
```

#### –®–∞–≥ 8.2: –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞ inline –∫–Ω–æ–ø–∫–∏
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –ó–ê–ú–ï–ù–ò–¢–¨ —Ñ—É–Ω–∫—Ü–∏—é process_description (—Å—Ç—Ä–æ–∫–∏ 267-320):

@router.message(ActivityStates.waiting_for_description)
async def process_description(message: types.Message, state: FSMContext):
    """Process activity description and show category selection."""
    description = message.text.strip()

    if not description:
        await message.answer(
            "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:",
            reply_markup=get_main_menu_keyboard()
        )
        return

    await state.update_data(description=description)

    category_service = CategoryService(api_client)
    user_service = UserService(api_client)
    telegram_id = message.from_user.id

    try:
        user = await user_service.get_by_telegram_id(telegram_id)
        if not user:
            await message.answer(
                "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                reply_markup=get_main_menu_keyboard()
            )
            await state.clear()
            return

        categories = await category_service.get_user_categories(user["id"])

        if not categories:
            await message.answer(
                "‚ö†Ô∏è –£ —Ç–µ–±—è –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é.",
                reply_markup=get_main_menu_keyboard()
            )
            await state.clear()
            return

        # Store categories and user_id for callback handlers
        await state.update_data(
            categories=categories,
            user_id=user["id"]
        )
        await state.set_state(ActivityStates.waiting_for_category)

        text = (
            "üìÇ –í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n\n"
            "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å \"0\" —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å."
        )

        await message.answer(
            text,
            reply_markup=get_poll_category_keyboard(categories)
        )

    except Exception as e:
        logger.error(f"Error in process_description: {e}")
        await message.answer(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.",
            reply_markup=get_main_menu_keyboard()
        )
        await state.clear()
```

#### –®–∞–≥ 8.3: –î–æ–±–∞–≤–∏—Ç—å callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è inline –∫–Ω–æ–ø–æ–∫
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –î–û–ë–ê–í–ò–¢–¨ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ process_description:

@router.callback_query(ActivityStates.waiting_for_category, F.data.startswith("poll_category_"))
async def process_category_callback(callback: types.CallbackQuery, state: FSMContext):
    """Process category selection via inline button."""
    category_id = int(callback.data.split("_")[-1])

    data = await state.get_data()
    categories = data.get("categories", [])

    # Find selected category
    selected_category = next(
        (cat for cat in categories if cat["id"] == category_id),
        None
    )

    if not selected_category:
        await callback.message.answer("‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        await callback.answer()
        return

    # Store category_id
    await state.update_data(category_id=category_id)

    # Show time selection
    text = (
        f"üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {selected_category.get('emoji', '')} {selected_category['name']}\n\n"
        "‚è∞ –í—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:"
    )

    await callback.message.answer(
        text,
        reply_markup=get_time_start_keyboard()
    )
    await state.set_state(ActivityStates.waiting_for_start_time)
    await callback.answer()


@router.callback_query(ActivityStates.waiting_for_category, F.data == "poll_cancel")
async def cancel_category_selection(callback: types.CallbackQuery, state: FSMContext):
    """Handle cancel button in category selection."""
    await state.clear()
    await callback.message.answer(
        "‚ùå –ó–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=get_main_menu_keyboard()
    )
    await callback.answer()
```

#### –®–∞–≥ 8.4: –û—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ process_category (—Å—Ç—Ä–æ–∫–∞ 323)
# —á—Ç–æ–±—ã –æ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Ç–æ–ª—å–∫–æ "0" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞:

@router.message(ActivityStates.waiting_for_category)
async def process_category_text(message: types.Message, state: FSMContext):
    """Process category selection via text (skip option only)."""
    text = message.text.strip()

    # Only allow "0" to skip category
    if text == "0":
        await state.update_data(category_id=None)

        text = "‚è∞ –í—ã–±–µ—Ä–∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:"
        await message.answer(
            text,
            reply_markup=get_time_start_keyboard()
        )
        await state.set_state(ActivityStates.waiting_for_start_time)
        return

    # Ignore other text input - user should use buttons
    await message.answer(
        "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.\n"
        "–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å \"0\" —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å."
    )
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ inline –∫–Ω–æ–ø–∫–∏ (–ø–æ 2 –≤ —Ä—è–¥—É)
- –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å—Ä–∞–∑—É –≤—ã–±–∏—Ä–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- –ï—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
- –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ "0" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£–¥–æ–±–Ω—ã–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π UX

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ "‚úèÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
2. –í–≤–µ—Å—Ç–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫ inline –∫–Ω–æ–ø–∫–∏
4. –í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫–Ω–æ–ø–∫–æ–π
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–¥–æ–ª–∂–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
6. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
7. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–≤–æ–¥ "0" –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

---

## üìã –£–õ–£–ß–®–ï–ù–ò–Ø –ö–ê–ß–ï–°–¢–í–ê

### ‚ú® –ó–ê–î–ê–ß–ê 9: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–Ω–æ–ø–æ–∫

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
**–§–∞–π–ª—ã:**
- –í—Å–µ handlers —Å callback_query –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- `services/tracker_activity_bot/src/api/handlers/activity.py`
- `services/tracker_activity_bot/src/api/handlers/categories.py`
- `services/tracker_activity_bot/src/api/handlers/settings.py`
- `services/tracker_activity_bot/src/api/handlers/poll.py`
- `services/tracker_activity_bot/src/api/handlers/main_menu.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è inline –∫–Ω–æ–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏, —á—Ç–æ –±–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å. –û—Å–æ–±–µ–Ω–Ω–æ –∑–∞–º–µ—Ç–Ω–æ –ø—Ä–∏ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö (–∑–∞–ø—Ä–æ—Å—ã –∫ API, —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ç.–¥.). –≠—Ç–æ —É—Ö—É–¥—à–∞–µ—Ç UX –∏ —Å–æ–∑–¥–∞—ë—Ç –æ—â—É—â–µ–Ω–∏–µ "–∑–∞–≤–∏—Å—à–µ–≥–æ" –±–æ—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:**
Telegram Bot API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `ChatAction.TYPING` - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç...", –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ –Ω–∞—á–∞–ª–æ –≤—Å–µ—Ö callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 9.1: –°–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∫–∞–∑–∞ typing action
```python
# –§–∞–π–ª: src/application/utils/decorators.py (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π)

"""Useful decorators for handlers."""
from functools import wraps
from typing import Callable
from aiogram import types
from aiogram.enums import ChatAction


def with_typing_action(func: Callable) -> Callable:
    """Decorator to show typing action before handler execution.

    Automatically shows "typing..." indicator when user clicks inline button
    or sends a message. Improves UX by providing immediate feedback.

    Usage:
        @router.callback_query(F.data == "something")
        @with_typing_action
        async def handler(callback: CallbackQuery, ...):
            # Typing action is automatically shown
            ...
    """
    @wraps(func)
    async def wrapper(event: types.CallbackQuery | types.Message, *args, **kwargs):
        # Determine chat_id and bot based on event type
        if isinstance(event, types.CallbackQuery):
            chat_id = event.message.chat.id
            bot = event.bot
        else:  # Message
            chat_id = event.chat.id
            bot = event.bot

        # Show typing action
        await bot.send_chat_action(chat_id=chat_id, action=ChatAction.TYPING)

        # Execute original handler
        return await func(event, *args, **kwargs)

    return wrapper
```

#### –®–∞–≥ 9.2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ä—É—á–Ω—É—é
–ï—Å–ª–∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å typing action –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:

```python
# –ü—Ä–∏–º–µ—Ä –¥–ª—è –ª—é–±–æ–≥–æ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:

@router.callback_query(F.data == "some_action")
async def handle_action(callback: types.CallbackQuery, state: FSMContext):
    """Handle some action."""
    # Show typing indicator
    await callback.bot.send_chat_action(
        chat_id=callback.message.chat.id,
        action=ChatAction.TYPING
    )

    # Rest of handler code
    ...
```

#### –®–∞–≥ 9.3: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º

**–§–∞–π–ª: activity.py**
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- `start_activity_recording` (—Å—Ç—Ä–æ–∫–∞ ~95)
- `list_recent_activities` (—Å—Ç—Ä–æ–∫–∞ ~122)
- `process_start_time_callback` (—Å—Ç—Ä–æ–∫–∞ ~164)
- `process_end_time_callback` (—Å—Ç—Ä–æ–∫–∞ ~201)
- `cancel_action` (—Å—Ç—Ä–æ–∫–∞ ~428)
- `process_category_callback` (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ –ó–ê–î–ê–ß–ò 8)

**–§–∞–π–ª: categories.py**
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- `show_categories` (—Å—Ç—Ä–æ–∫–∞ ~41)
- `create_category_start` (—Å—Ç—Ä–æ–∫–∞ ~74)
- `edit_category_start` (—Å—Ç—Ä–æ–∫–∞ ~192)
- `delete_category_start` (—Å—Ç—Ä–æ–∫–∞ ~311)
- `delete_category_confirm` (—Å—Ç—Ä–æ–∫–∞ ~337)
- `delete_category_execute` (—Å—Ç—Ä–æ–∫–∞ ~365)

**–§–∞–π–ª: settings.py**
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- `show_settings_menu` (—Å—Ç—Ä–æ–∫–∞ ~82)
- `show_interval_menu` (—Å—Ç—Ä–æ–∫–∞ ~130)
- `show_weekday_interval_menu` (—Å—Ç—Ä–æ–∫–∞ ~148)
- `set_weekday_interval` (—Å—Ç—Ä–æ–∫–∞ ~194)
- `show_weekend_interval_menu` (—Å—Ç—Ä–æ–∫–∞ ~223)
- `set_weekend_interval` (—Å—Ç—Ä–æ–∫–∞ ~252)
- `show_quiet_hours_menu` (—Å—Ç—Ä–æ–∫–∞ ~284)
- `toggle_quiet_hours` (—Å—Ç—Ä–æ–∫–∞ ~323)
- `show_quiet_time_inputs` (—Å—Ç—Ä–æ–∫–∞ ~359)
- `show_reminders_menu` (—Å—Ç—Ä–æ–∫–∞ ~490)
- `toggle_reminders` (—Å—Ç—Ä–æ–∫–∞ ~521)
- `show_reminder_delay_menu` (—Å—Ç—Ä–æ–∫–∞ ~542)
- `set_reminder_delay` (—Å—Ç—Ä–æ–∫–∞ ~553)
- `return_to_main_menu` (—Å—Ç—Ä–æ–∫–∞ ~609)

**–§–∞–π–ª: poll.py**
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- `handle_poll_skip` (—Å—Ç—Ä–æ–∫–∞ ~108)
- `handle_poll_sleep` (—Å—Ç—Ä–æ–∫–∞ ~143)
- `handle_poll_remind` (—Å—Ç—Ä–æ–∫–∞ ~234)
- `handle_poll_reminder_ok` (—Å—Ç—Ä–æ–∫–∞ ~282)
- `handle_poll_activity_start` (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ –ó–ê–î–ê–ß–ò 1)
- `handle_poll_category_select` (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ –ó–ê–î–ê–ß–ò 1)

**–§–∞–π–ª: main_menu.py**
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
- –í—Å–µ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é

#### –®–∞–≥ 9.4: –ü—Ä–∏–º–µ—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
```python
# –§–∞–π–ª: src/api/handlers/activity.py
# –î–û–ë–ê–í–ò–¢–¨ –∏–º–ø–æ—Ä—Ç:
from src.application.utils.decorators import with_typing_action

# –ü–†–ò–ú–ï–ù–ò–¢–¨ –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º:
@router.callback_query(F.data == "start_activity")
@with_typing_action
async def start_activity_recording(callback: types.CallbackQuery, state: FSMContext):
    """Start recording a new activity."""
    # Typing action –ø–æ–∫–∞–∑–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    text = (
        "‚úèÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å\n\n"
        "–û–ø–∏—à–∏ —á–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è:"
    )
    ...
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ—Å–ª–µ –∫–ª–∏–∫–∞ –Ω–∞ –ª—é–±—É—é inline –∫–Ω–æ–ø–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ä–∞–∑—É –≤–∏–¥–∏—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç..."
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ù–µ—Ç –æ—â—É—â–µ–Ω–∏—è "–∑–∞–≤–∏—Å—à–µ–≥–æ" –±–æ—Ç–∞
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π UX

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
1. –ù–∞–∂–∞—Ç—å –ª—é–±—É—é –∫–Ω–æ–ø–∫—É –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã: –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ä–æ—Å—ã
5. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –î–ª—è –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (>2 —Å–µ–∫—É–Ω–¥) –º–æ–∂–Ω–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å typing action
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ ChatAction –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
  - `ChatAction.TYPING` - –æ–±—â–∏–π —Å–ª—É—á–∞–π
  - `ChatAction.UPLOAD_DOCUMENT` - –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö
  - `ChatAction.CHOOSE_STICKER` - –∑–∞–±–∞–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

---

### ‚ú® –ó–ê–î–ê–ß–ê 10: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ –ø–æ–ª—É—á–µ–Ω–∏—è user/settings

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/settings.py`
- `services/tracker_activity_bot/src/api/handlers/poll.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–í –∫–∞–∂–¥–æ–º handler –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è user –∏ settings.

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 10.1: –°–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–ª–∏ dependency
```python
# –§–∞–π–ª: src/application/utils/dependencies.py (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π)

"""Dependency injection utilities for handlers."""
from functools import wraps
from typing import Callable, Any
from aiogram import types
from aiogram.fsm.context import FSMContext

from src.infrastructure.http_clients.http_client import DataAPIClient
from src.infrastructure.http_clients.user_service import UserService
from src.infrastructure.http_clients.user_settings_service import UserSettingsService
from src.api.keyboards.main_menu import get_main_menu_keyboard

api_client = DataAPIClient()


async def get_user_and_settings(telegram_id: int) -> tuple[dict | None, dict | None]:
    """Get user and settings by telegram ID.

    Args:
        telegram_id: Telegram user ID

    Returns:
        Tuple of (user, settings) or (None, None) if not found
    """
    user_service = UserService(api_client)
    settings_service = UserSettingsService(api_client)

    user = await user_service.get_by_telegram_id(telegram_id)
    if not user:
        return None, None

    settings = await settings_service.get_settings(user["id"])
    return user, settings


def require_user_settings(func: Callable) -> Callable:
    """Decorator to require user and settings for handler.

    Automatically fetches user and settings, passes them to handler.
    Shows error message if user not found.

    Usage:
        @router.callback_query(F.data == "something")
        @require_user_settings
        async def handler(callback: CallbackQuery, state: FSMContext, user: dict, settings: dict):
            # user and settings are automatically injected
            ...
    """
    @wraps(func)
    async def wrapper(event: types.CallbackQuery | types.Message, state: FSMContext, **kwargs):
        telegram_id = event.from_user.id
        user, settings = await get_user_and_settings(telegram_id)

        if not user:
            message = event.message if isinstance(event, types.CallbackQuery) else event
            await message.answer(
                "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–ø—Ä–∞–≤—å /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.",
                reply_markup=get_main_menu_keyboard()
            )
            if isinstance(event, types.CallbackQuery):
                await event.answer()
            return

        if not settings:
            message = event.message if isinstance(event, types.CallbackQuery) else event
            await message.answer(
                "‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
                reply_markup=get_main_menu_keyboard()
            )
            if isinstance(event, types.CallbackQuery):
                await event.answer()
            return

        # Inject user and settings into handler
        return await func(event, state, user=user, settings=settings, **kwargs)

    return wrapper
```

#### –®–∞–≥ 10.2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ handlers
```python
# –§–∞–π–ª: src/api/handlers/settings.py
# –ü–†–ò–ú–ï–† –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

from src.application.utils.dependencies import require_user_settings

@router.callback_query(F.data == "settings")
@require_user_settings
async def show_settings_menu(callback: types.CallbackQuery, user: dict, settings: dict):
    """Show main settings menu."""
    # –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ:
    # user_service = UserService(api_client)
    # settings_service = UserSettingsService(api_client)
    # telegram_id = callback.from_user.id
    # user = await user_service.get_by_telegram_id(telegram_id)
    # settings = await settings_service.get_settings(user["id"])

    # –°—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–µ–º:
    weekday_h = settings["poll_interval_weekday"] // 60
    weekend_h = settings["poll_interval_weekend"] // 60
    ...
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ. –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á.

---

### ‚ú® –ó–ê–î–ê–ß–ê 11: –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
**–§–∞–π–ª—ã:**
- –í—Å–µ handlers

**–ü—Ä–æ–±–ª–µ–º–∞:**
–û–±—â–∏–µ –±–ª–æ–∫–∏ `except Exception as e` –Ω–µ –¥–∞—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ —É—Å–ª–æ–∂–Ω—è—é—Ç –æ—Ç–ª–∞–¥–∫—É.

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 11.1: –°–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
```python
# –ü—Ä–∏–º–µ—Ä —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:

try:
    # ... code
except httpx.HTTPStatusError as e:
    if e.response.status_code == 404:
        await message.answer("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
    elif e.response.status_code == 409:
        await message.answer("‚ö†Ô∏è –¢–∞–∫–∞—è –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
    elif e.response.status_code >= 500:
        await message.answer("‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
        logger.error(f"Server error: {e}", exc_info=True)
    else:
        await message.answer(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É (–∫–æ–¥ {e.response.status_code}).")
        logger.error(f"HTTP error: {e}", exc_info=True)
except httpx.RequestError as e:
    await message.answer("‚ö†Ô∏è –ù–µ –º–æ–≥—É —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.")
    logger.error(f"Request error: {e}", exc_info=True)
except ValueError as e:
    await message.answer(f"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
except Exception as e:
    await message.answer("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")
    logger.error(f"Unexpected error: {e}", exc_info=True)
```

**–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –æ—Å–Ω–æ–≤–Ω—ã–º handlers –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö:**
- `activity.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ save_activity, process_*
- `categories.py` - create_category_final, delete_category_execute
- `settings.py` - –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `poll.py` - handle_poll_*, send_automatic_poll

---

### ‚ú® –ó–ê–î–ê–ß–ê 12: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
**–§–∞–π–ª—ã:**
- –í—Å–µ keyboards

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–∞—Ö –∫–Ω–æ–ø–æ–∫ "–ù–∞–∑–∞–¥":
- "üîô –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π"
- "üîô –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º"
- "üîô –ù–∞–∑–∞–¥"

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 12.1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
```python
# –í—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ö–æ—Ä–æ—Ç–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π
"üîô –ù–∞–∑–∞–¥"

# –í–∞—Ä–∏–∞–Ω—Ç 2: –° –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
"üîô –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"
"üîô –ö –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º"
```

#### –®–∞–≥ 12.2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º
```python
# –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
# - src/api/keyboards/settings.py
# - src/api/keyboards/poll.py
# - src/api/handlers/categories.py (inline keyboards)
```

---

### ‚ú® –ó–ê–î–ê–ß–ê 13: –£—Ç–æ—á–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–ø—Ä–æ—Å–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/poll.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–¢–µ–∫—Å—Ç "–ß–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ —á–∞—Å—ã?" –Ω–µ—Ç–æ—á–µ–Ω, —Ç.–∫. –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–æ–∂–µ—Ç –±—ã—Ç—å 30 –º–∏–Ω—É—Ç –∏–ª–∏ 6 —á–∞—Å–æ–≤.

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 13.1: –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π
```python
# –§–∞–π–ª: src/api/handlers/poll.py
# –ó–ê–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫–∏ 63-66:

        # Send poll message
        text = (
            "‚è∞ –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!\n\n"
            "–ß–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–ø—Ä–æ—Å–∞?\n\n"
            "–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:"
        )
```

**–ò–ª–∏ –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏:**
```python
        # Calculate time since last poll
        from datetime import datetime, timezone, timedelta
        is_weekend = datetime.now(timezone.utc).weekday() >= 5
        interval_minutes = (
            settings["poll_interval_weekend"]
            if is_weekend
            else settings["poll_interval_weekday"]
        )

        hours = interval_minutes // 60
        minutes = interval_minutes % 60

        if hours > 0 and minutes > 0:
            time_str = f"{hours}—á {minutes}–º"
        elif hours > 0:
            time_str = f"{hours}—á"
        else:
            time_str = f"{minutes}–º"

        text = (
            "‚è∞ –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!\n\n"
            f"–ß–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ {time_str}?\n\n"
            "–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:"
        )
```

---

### ‚ú® –ó–ê–î–ê–ß–ê 14: –í—ã–Ω–µ—Å—Ç–∏ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ñ–ï–õ–ê–¢–ï–õ–¨–ù–û
**–§–∞–π–ª—ã:**
- `services/tracker_activity_bot/src/api/handlers/poll.py`
- –°–æ–∑–¥–∞—Ç—å `services/tracker_activity_bot/src/core/constants.py`

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ú–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–¥–µ —Å–Ω–∏–∂–∞—é—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ —É—Å–ª–æ–∂–Ω—è—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è.

**–®–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

#### –®–∞–≥ 14.1: –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
```python
# –§–∞–π–ª: src/core/constants.py (—Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π)

"""Application constants."""

# Poll settings
DEFAULT_SLEEP_DURATION_HOURS = 8
"""Default sleep duration when last_poll_time is unknown"""

POLL_POSTPONE_MINUTES = 10
"""Minutes to postpone poll if user is busy"""

# Activity settings
MIN_ACTIVITY_DURATION_MINUTES = 1
"""Minimum activity duration in minutes"""

MAX_ACTIVITY_LIMIT = 10
"""Maximum number of activities to show in list"""

# Validation limits
MIN_POLL_INTERVAL_MINUTES = 30
MAX_POLL_INTERVAL_WEEKDAY_MINUTES = 480  # 8 hours
MAX_POLL_INTERVAL_WEEKEND_MINUTES = 600  # 10 hours

MIN_REMINDER_DELAY_MINUTES = 5
MAX_REMINDER_DELAY_MINUTES = 120

MIN_CATEGORY_NAME_LENGTH = 2
MAX_CATEGORY_NAME_LENGTH = 50
```

#### –®–∞–≥ 14.2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –∫–æ–¥–µ
```python
# –§–∞–π–ª: src/api/handlers/poll.py
# –î–û–ë–ê–í–ò–¢–¨ –∏–º–ø–æ—Ä—Ç:
from src.core.constants import (
    DEFAULT_SLEEP_DURATION_HOURS,
    POLL_POSTPONE_MINUTES
)

# –ó–ê–ú–ï–ù–ò–¢–¨ —Å—Ç—Ä–æ–∫—É 168:
# –ë–´–õ–û:
start_time = datetime.now(timezone.utc) - timedelta(hours=8)

# –°–¢–ê–õ–û:
start_time = datetime.now(timezone.utc) - timedelta(hours=DEFAULT_SLEEP_DURATION_HOURS)
```

---

## üìä –ö–û–ù–¢–†–û–õ–¨–ù–´–ô –°–ü–ò–°–û–ö

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (–ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ production):
- [ ] **–ó–ê–î–ê–ß–ê 1**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–ø—Ä–æ—Å "–Ø –∑–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ"
  - [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≤ keyboard
  - [ ] –°–æ–∑–¥–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏
  - [ ] –°–æ–∑–¥–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  - [ ] –°–æ–∑–¥–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–∫–≤–æ–∑–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ

- [ ] **–ó–ê–î–ê–ß–ê 2**: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤–≤–æ–¥–∞
  - [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –±—É–¥–Ω–∏—Ö –¥–Ω–µ–π
  - [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö
  - [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–µ—Ä–∂–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞

- [ ] **–ó–ê–î–ê–ß–ê 3**: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /cancel
  - [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ settings.py
  - [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ activity.py
  - [ ] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ categories.py
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–º–µ–Ω–∞ –≤–æ –≤—Å–µ—Ö FSM

### –í–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–ø–µ—Ä–µ–¥ Level 2):
- [ ] **–ó–ê–î–ê–ß–ê 4**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä
  - [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ get_quiet_hours_main_keyboard
  - [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ get_reminders_keyboard
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞

- [ ] **–ó–ê–î–ê–ß–ê 5**: –î–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_poll_time
  - [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è –≤ API
  - [ ] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞—Å—á—ë—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–Ω–∞

- [ ] **–ó–ê–î–ê–ß–ê 6**: –î–æ–±–∞–≤–∏—Ç—å keyboard –ø–æ—Å–ª–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
  - [ ] –î–æ–±–∞–≤–ª–µ–Ω reply_markup –≤ activity.py:245
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

- [ ] **–ó–ê–î–ê–ß–ê 7**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ FSM
  - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  - [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–Ω–∏–µ –æ–ø—Ä–æ—Å–∞
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç

- [ ] **–ó–ê–î–ê–ß–ê 8**: –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ inline –∫–Ω–æ–ø–∫–∏
  - [ ] –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç get_poll_category_keyboard
  - [ ] –ó–∞–º–µ–Ω—ë–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞ inline –∫–Ω–æ–ø–∫–∏
  - [ ] –î–æ–±–∞–≤–ª–µ–Ω callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫
  - [ ] –î–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
  - [ ] –û–±–Ω–æ–≤–ª—ë–Ω —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è "0")
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ

### –£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] **–ó–ê–î–ê–ß–ê 9**: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–Ω–æ–ø–æ–∫
  - [ ] –°–æ–∑–¥–∞–Ω –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä with_typing_action
  - [ ] –ü—Ä–∏–º–µ–Ω—ë–Ω –∫–æ –≤—Å–µ–º callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤ activity.py
  - [ ] –ü—Ä–∏–º–µ–Ω—ë–Ω –∫–æ –≤—Å–µ–º callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤ categories.py
  - [ ] –ü—Ä–∏–º–µ–Ω—ë–Ω –∫–æ –≤—Å–µ–º callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤ settings.py
  - [ ] –ü—Ä–∏–º–µ–Ω—ë–Ω –∫–æ –≤—Å–µ–º callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –≤ poll.py
  - [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤–æ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö
- [ ] **–ó–ê–î–ê–ß–ê 10**: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- [ ] **–ó–ê–î–ê–ß–ê 11**: –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] **–ó–ê–î–ê–ß–ê 12**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
- [ ] **–ó–ê–î–ê–ß–ê 13**: –£—Ç–æ—á–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –æ–ø—Ä–æ—Å–µ
- [ ] **–ó–ê–î–ê–ß–ê 14**: –í—ã–Ω–µ—Å—Ç–∏ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —á–∏—Å–ª–∞ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã

---

## üéØ –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–î–µ–Ω—å 1-2)
1. –ó–ê–î–ê–ß–ê 1 - –û–ø—Ä–æ—Å "–ó–∞–Ω–∏–º–∞–ª—Å—è —á–µ–º-—Ç–æ" (2-3 —á–∞—Å–∞)
2. –ó–ê–î–ê–ß–ê 2 - –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤–≤–æ–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (1-2 —á–∞—Å–∞)
3. –ó–ê–î–ê–ß–ê 3 - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ /cancel (30 –º–∏–Ω—É—Ç)

**–ò—Ç–æ–≥–æ:** 4-6 —á–∞—Å–æ–≤

### –§–∞–∑–∞ 2: –í–∞–∂–Ω—ã–µ –Ω–µ–¥–æ—á–µ—Ç—ã (–î–µ–Ω—å 2-3)
4. –ó–ê–î–ê–ß–ê 4 - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (30 –º–∏–Ω—É—Ç)
5. –ó–ê–î–ê–ß–ê 5 - last_poll_time (1 —á–∞—Å)
6. –ó–ê–î–ê–ß–ê 6 - Keyboard –≤ activity (5 –º–∏–Ω—É—Ç)
7. –ó–ê–î–ê–ß–ê 7 - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ FSM (1-2 —á–∞—Å–∞)
8. –ó–ê–î–ê–ß–ê 8 - Inline –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (1 —á–∞—Å)

**–ò—Ç–æ–≥–æ:** 4-5 —á–∞—Å–æ–≤

### –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–∏—è (–î–µ–Ω—å 3-4)
9. –ó–ê–î–ê–ß–ê 9 - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (2-3 —á–∞—Å–∞)
10-14. –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ –∂–µ–ª–∞–Ω–∏—é

**–ò—Ç–æ–≥–æ:** 5-8 —á–∞—Å–æ–≤

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

### –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏** - –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. **–î–µ–ª–∞–π—Ç–µ git commit** –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
3. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏** - –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è scheduler –∏ FSM
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ docker-compose restart** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ** - —ç–º—É–ª—è—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω–∞—á–µ

### –ü–æ—Ä—è–¥–æ–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ flow (–±–µ–∑ –æ—à–∏–±–æ–∫)
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–Ω–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥)
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–º–µ–Ω—ã (–∫–Ω–æ–ø–∫–∏ –∏ /cancel)

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏:
- –ó–ê–î–ê–ß–ê 1 –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö
- –ó–ê–î–ê–ß–ê 2 –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö
- –ó–ê–î–ê–ß–ê 3 –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥—Ä—É–≥–∏—Ö
- –ó–ê–î–ê–ß–ê 5 –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API
- –ó–ê–î–ê–ß–ê 7 –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã FSM –∏–∑ main.py
- –ó–ê–î–ê–ß–ê 8 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é get_poll_category_keyboard –∏–∑ poll.py
- –ó–ê–î–ê–ß–ê 9 —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ decorators.py –∏ –ø—Ä–∏–º–µ–Ω–∏–º–∞ –∫–æ –≤—Å–µ–º handlers

---

## üîó –°–°–´–õ–ö–ò

- –ò—Å—Ö–æ–¥–Ω—ã–π –∞—É–¥–∏—Ç: `artifacts/analysis/ui-audit-2025-11-05.md`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Aiogram: https://docs.aiogram.dev/
- –ö–æ–¥ FSM: `src/api/states/*.py`
- –ö–æ–¥ handlers: `src/api/handlers/*.py`
- –ö–æ–¥ keyboards: `src/api/keyboards/*.py`

---

**–ö–æ–Ω–µ—Ü TODO —Ñ–∞–π–ª–∞**

–ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é! üöÄ
